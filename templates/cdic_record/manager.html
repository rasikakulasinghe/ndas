{% extends 'src/base.html' %}
{% load static %}
{% block title %}CDIC Records Manager{% endblock title %}

{% block main_content %}
<div class="content-wrapper">
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0">
            <i class="fas fa-clipboard-list text-primary mr-2"></i>CDIC Records Manager
            {% if patient %}
              <small class="text-muted"> :: {{ patient.baby_name }}</small>
            {% endif %}
          </h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
            {% if patient %}
              <li class="breadcrumb-item"><a href="{% url 'cdic-assessment-manager' %}">CDIC Records</a></li>
              <li class="breadcrumb-item active">{{ patient.baby_name }}</li>
            {% else %}
              <li class="breadcrumb-item active">CDIC Records</li>
            {% endif %}
          </ol>
        </div>
      </div>
    </div>
  </div>

  <section class="content">
    <div class="container-fluid">

      <!-- Statistics Cards -->
      <div class="row mb-4">
        <div class="col-lg-3 col-6">
          <div class="small-box bg-info">
            <div class="inner">
              <h3>{{ cdic_stats.total|default:0 }}</h3>
              <p>Total CDIC Records</p>
            </div>
            <div class="icon">
              <i class="fas fa-clipboard-list"></i>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-6">
          <div class="small-box bg-success">
            <div class="inner">
              <h3>{{ cdic_stats.completed|default:0 }}</h3>
              <p>Completed Assessments</p>
            </div>
            <div class="icon">
              <i class="fas fa-check-circle"></i>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-6">
          <div class="small-box bg-warning">
            <div class="inner">
              <h3>{{ cdic_stats.pending|default:0 }}</h3>
              <p>Pending Follow-ups</p>
            </div>
            <div class="icon">
              <i class="fas fa-clock"></i>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-6">
          <div class="small-box bg-secondary">
            <div class="inner">
              <h3>{{ cdic_stats.this_week|default:0 }}</h3>
              <p>This Week</p>
            </div>
            <div class="icon">
              <i class="fas fa-calendar-week"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Search and Filter Section -->
      <div class="card card-secondary collapsed-card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-search mr-2"></i>Search & Filter Options
          </h3>
          <div class="card-tools">
            <button type="button" class="btn btn-tool" data-card-widget="collapse">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>
        <div class="card-body" style="display: none;">
          <form method="GET" id="searchForm">
            <div class="row">
              <div class="col-md-3">
                <div class="form-group">
                  <label for="search_patient">Search Patient</label>
                  <input type="text" class="form-control" id="search_patient" name="search_patient" 
                         value="{{ request.GET.search_patient }}" placeholder="Enter patient name...">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label for="date_range">Assessment Date Range</label>
                  <select class="form-control" id="date_range" name="date_range">
                    <option value="">All Time</option>
                    <option value="today" {% if request.GET.date_range == 'today' %}selected{% endif %}>Today</option>
                    <option value="week" {% if request.GET.date_range == 'week' %}selected{% endif %}>This Week</option>
                    <option value="month" {% if request.GET.date_range == 'month' %}selected{% endif %}>This Month</option>
                    <option value="quarter" {% if request.GET.date_range == 'quarter' %}selected{% endif %}>This Quarter</option>
                    <option value="year" {% if request.GET.date_range == 'year' %}selected{% endif %}>This Year</option>
                  </select>
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label for="follow_up_status">Follow-up Status</label>
                  <select class="form-control" id="follow_up_status" name="follow_up_status">
                    <option value="">All Records</option>
                    <option value="pending" {% if request.GET.follow_up_status == 'pending' %}selected{% endif %}>Pending Follow-up</option>
                    <option value="completed" {% if request.GET.follow_up_status == 'completed' %}selected{% endif %}>Completed</option>
                    <option value="overdue" {% if request.GET.follow_up_status == 'overdue' %}selected{% endif %}>Overdue</option>
                  </select>
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label for="created_by">Created By</label>
                  <input type="text" class="form-control" id="created_by" name="created_by" 
                         value="{{ request.GET.created_by }}" placeholder="Enter username...">
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-12">
                <button type="submit" class="btn btn-primary mr-2">
                  <i class="fas fa-search mr-1"></i>Search
                </button>
                <a href="{% url 'cdic-assessment-manager' %}{% if patient %}{{ patient.id }}{% endif %}" class="btn btn-secondary">
                  <i class="fas fa-times mr-1"></i>Clear Filters
                </a>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Results Section -->
      {% if cdic_record_list %}
        <div class="card">
          <div class="card-header bg-primary">
            <h3 class="card-title">
              <i class="fas fa-list mr-2"></i>CDIC Assessment Records
              <span class="badge badge-light ml-2">{{ cdic_record_list|length }} records</span>
            </h3>
            <div class="card-tools">
              <div class="input-group input-group-sm" style="width: 250px;">
                <input type="text" id="quickSearch" class="form-control float-right" placeholder="Quick search...">
                <div class="input-group-append">
                  <button type="submit" class="btn btn-default">
                    <i class="fas fa-search"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="card-body table-responsive p-0">
            <table class="table table-hover text-nowrap" id="cdicTable">
              <thead>
                <tr>
                  <th><i class="fas fa-hashtag mr-1"></i>ID</th>
                  <th><i class="fas fa-user mr-1"></i>Patient Name</th>
                  <th><i class="fas fa-calendar-alt mr-1"></i>Assessment Date</th>
                  <th><i class="fas fa-calendar-check mr-1"></i>Next Appointment</th>
                  <th><i class="fas fa-user-plus mr-1"></i>Created By</th>
                  <th><i class="fas fa-cogs mr-1"></i>Actions</th>
                </tr>
              </thead>
              <tbody>

                {% for CDICRecord in cdic_record_list %}
                <tr data-cdic-id="{{ CDICRecord.id }}">
                  <td>
                    <div class="d-flex align-items-center">
                      <span class="badge badge-secondary mr-2">{{ CDICRecord.id }}</span>
                      {% if CDICRecord.isBookmarked %}
                        <a href="{% url 'bookmark-view' CDICRecord.isBookmarked.id %}" 
                           data-toggle="tooltip" data-placement="top" title="Bookmarked" 
                           class="text-primary">
                          <i class="fas fa-bookmark"></i>
                        </a>
                      {% endif %}
                    </div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="user-panel-info">
                        <a href="{% url 'view-patient' CDICRecord.patient.id %}" class="text-decoration-none">
                          <strong>{{ CDICRecord.patient.baby_name }}</strong>
                        </a>
                        {% if CDICRecord.patient.getCurrentAge %}
                          <br><small class="text-muted">{{ CDICRecord.patient.getCurrentAge }}</small>
                        {% endif %}
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="assessment-date">
                      <i class="fas fa-calendar text-info mr-1"></i>
                      <strong>{{ CDICRecord.assessment_date|date:"M d, Y" }}</strong>
                      <br><small class="text-muted">{{ CDICRecord.assessment_date|timesince }} ago</small>
                    </div>
                  </td>
                  <td>
                    {% if CDICRecord.next_appointment_date %}
                      <div class="next-appointment">
                        {% now "Y-m-d" as today %}
                        {% if CDICRecord.next_appointment_date|date:"Y-m-d" < today %}
                          <span class="badge badge-danger"><i class="fas fa-exclamation-triangle mr-1"></i>Overdue</span>
                          <br><small class="text-danger">{{ CDICRecord.next_appointment_date|date:"M d, Y" }}</small>
                        {% elif CDICRecord.next_appointment_date|date:"Y-m-d" == today %}
                          <span class="badge badge-warning"><i class="fas fa-clock mr-1"></i>Due Today</span>
                          <br><small class="text-warning">{{ CDICRecord.next_appointment_date|date:"M d, Y" }}</small>
                        {% else %}
                          <span class="badge badge-success"><i class="fas fa-calendar-check mr-1"></i>Scheduled</span>
                          <br><small class="text-success">{{ CDICRecord.next_appointment_date|date:"M d, Y" }}</small>
                        {% endif %}
                      </div>
                    {% else %}
                      <span class="text-muted font-italic">Not scheduled</span>
                    {% endif %}
                  </td>
                  <td>
                    <div data-toggle="tooltip" data-placement="top" 
                         title="Created: {{ CDICRecord.created_on|date:'F d, Y g:i A' }}{% if CDICRecord.edit_by %} | Last edited: {{ CDICRecord.edit_on|date:'F d, Y g:i A' }} by {{ CDICRecord.edit_by.username }}{% endif %}">
                      <a href="{% url 'user-view-by-username' CDICRecord.created_by.username %}" class="text-decoration-none">
                        <i class="fas fa-user text-primary mr-1"></i>{{ CDICRecord.created_by.username }}
                      </a>
                      <br><small class="text-muted">{{ CDICRecord.created_on|timesince }} ago</small>
                    </div>
                  </td>
                  <td>
                    <div class="btn-group" role="group">
                      <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                              data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-cogs"></i> Actions
                      </button>
                      <div class="dropdown-menu dropdown-menu-right">
                        <!-- Primary Actions -->
                        <a class="dropdown-item" href="{% url 'cdic-assessment-view' CDICRecord.id %}">
                          <i class="fas fa-eye text-info mr-2"></i>View Record
                        </a>
                        <a class="dropdown-item" href="{% url 'cdic-assessment-edit' CDICRecord.id %}">
                          <i class="fas fa-edit text-warning mr-2"></i>Edit Record
                        </a>
                        <div class="dropdown-divider"></div>
                        
                        <!-- Related Records -->
                        <a class="dropdown-item" href="{% url 'view-patient' CDICRecord.patient.id %}">
                          <i class="fas fa-user text-primary mr-2"></i>View Patient
                        </a>
                        <a class="dropdown-item" href="{% url 'cdic-assessment-manager-patient' CDICRecord.patient.id %}">
                          <i class="fas fa-list text-secondary mr-2"></i>All Patient CDIC Records
                        </a>
                        <div class="dropdown-divider"></div>
                        
                        <!-- Bookmark Actions -->
                        {% if CDICRecord.isBookmarked %}
                          <a class="dropdown-item" href="{% url 'bookmark-view' CDICRecord.isBookmarked.id %}">
                            <i class="fas fa-bookmark text-primary mr-2"></i>View Bookmark
                          </a>
                        {% else %}
                          <a class="dropdown-item" href="{% url 'bookmark-add' CDICRecord.id 'CDICR' %}">
                            <i class="fas fa-plus text-success mr-2"></i>Add Bookmark
                          </a>
                        {% endif %}
                        
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item text-danger" href="{% url 'cdic-assessment-delete_start' CDICRecord.id %}" 
                           onclick="return confirm('Are you sure you want to delete this CDIC record?')">
                          <i class="fas fa-trash-alt mr-2"></i>Delete Record
                        </a>
                      </div>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          <!-- Pagination -->
          {% if patients_page_obj and patients_page_obj.paginator.num_pages > 1 %}
            <div class="card-footer">
              <div class="row align-items-center">
                <div class="col-sm-6">
                  <div class="dataTables_info">
                    Showing {{ patients_page_obj.start_index }} to {{ patients_page_obj.end_index }} 
                    of {{ patients_page_obj.paginator.count }} entries
                  </div>
                </div>
                <div class="col-sm-6">
                  <nav aria-label="CDIC records pagination">
                    <ul class="pagination pagination-sm justify-content-end mb-0">
                      {% if patients_page_obj.has_previous %}
                        <li class="page-item">
                          <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1">
                            <i class="fas fa-angle-double-left"></i>
                          </a>
                        </li>
                        <li class="page-item">
                          <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ patients_page_obj.previous_page_number }}">
                            <i class="fas fa-angle-left"></i>
                          </a>
                        </li>
                      {% else %}
                        <li class="page-item disabled">
                          <span class="page-link"><i class="fas fa-angle-double-left"></i></span>
                        </li>
                        <li class="page-item disabled">
                          <span class="page-link"><i class="fas fa-angle-left"></i></span>
                        </li>
                      {% endif %}
                      
                      <!-- Page numbers -->
                      {% for page_num in patients_page_obj.paginator.page_range %}
                        {% if page_num == patients_page_obj.number %}
                          <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                          </li>
                        {% elif page_num > patients_page_obj.number|add:'-3' and page_num < patients_page_obj.number|add:'3' %}
                          <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_num }}">{{ page_num }}</a>
                          </li>
                        {% endif %}
                      {% endfor %}
                      
                      {% if patients_page_obj.has_next %}
                        <li class="page-item">
                          <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ patients_page_obj.next_page_number }}">
                            <i class="fas fa-angle-right"></i>
                          </a>
                        </li>
                        <li class="page-item">
                          <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ patients_page_obj.paginator.num_pages }}">
                            <i class="fas fa-angle-double-right"></i>
                          </a>
                        </li>
                      {% else %}
                        <li class="page-item disabled">
                          <span class="page-link"><i class="fas fa-angle-right"></i></span>
                        </li>
                        <li class="page-item disabled">
                          <span class="page-link"><i class="fas fa-angle-double-right"></i></span>
                        </li>
                      {% endif %}
                    </ul>
                  </nav>
                </div>
              </div>
            </div>
          {% endif %}
        </div>
      
      {% else %}
        <!-- No Results Found -->
        <div class="card">
          <div class="card-body text-center py-5">
            <div class="mb-3">
              <i class="fas fa-clipboard-list fa-3x text-muted"></i>
            </div>
            <h4 class="text-muted mb-3">No CDIC Records Found</h4>
            <p class="text-muted mb-4">
              {% if request.GET %}
                No CDIC records match your search criteria. Try adjusting your filters.
              {% else %}
                No CDIC assessment records have been created yet.
              {% endif %}
            </p>
            <div class="btn-group" role="group">
              {% if patient %}
                <a href="{% url 'cdic-assessment-manager' %}" class="btn btn-outline-primary">
                  <i class="fas fa-list mr-1"></i>View All Records
                </a>
              {% else %}
                <a href="{% url 'cdic-assessment-manager' %}" class="btn btn-outline-primary">
                  <i class="fas fa-refresh mr-1"></i>Reset Filters
                </a>
              {% endif %}
              <a href="{% url 'home' %}" class="btn btn-primary">
                <i class="fas fa-home mr-1"></i>Go to Dashboard
              </a>
            </div>
          </div>
        </div>
      {% endif %}
      
    </div>
  </section>
</div>

<!-- Custom Styles -->
<style>
.small-box .inner h3 {
  font-size: 2.2rem;
  font-weight: bold;
}

.badge {
  font-size: 0.85em;
}

.table td {
  vertical-align: middle;
}

.dropdown-menu {
  min-width: 200px;
}

.dropdown-item i {
  width: 20px;
  text-align: center;
}

.user-panel-info a {
  color: #495057;
}

.user-panel-info a:hover {
  color: #007bff;
}

.assessment-date {
  white-space: nowrap;
}

.next-appointment {
  white-space: nowrap;
}

.quick-search-highlight {
  background-color: yellow;
  font-weight: bold;
}

.card-tools .input-group {
  width: auto;
}

@media (max-width: 768px) {
  .table-responsive {
    border: none;
  }
  
  .small-box .inner h3 {
    font-size: 1.8rem;
  }
  
  .badge {
    font-size: 0.75em;
  }
  
  .btn-group .dropdown-toggle {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
  }
  
  .assessment-date,
  .next-appointment {
    white-space: normal;
  }
}

.dataTables_info {
  font-size: 0.875rem;
  color: #6c757d;
}

.pagination-sm .page-link {
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
}

.content-header h1 {
  margin: 0;
  font-size: 1.8rem;
}

.badge-danger {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
  }
}
</style>

<!-- Custom JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    $('[data-toggle="tooltip"]').tooltip();
    
    // Quick search functionality
    const quickSearch = document.getElementById('quickSearch');
    const table = document.getElementById('cdicTable');
    const tbody = table.querySelector('tbody');
    const originalRows = Array.from(tbody.querySelectorAll('tr'));
    
    if (quickSearch) {
        quickSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                // Show all rows
                originalRows.forEach(row => {
                    tbody.appendChild(row);
                    row.style.display = '';
                    // Remove highlight
                    row.querySelectorAll('.quick-search-highlight').forEach(el => {
                        el.outerHTML = el.innerHTML;
                    });
                });
                return;
            }
            
            // Filter and highlight matching rows
            let visibleRows = 0;
            originalRows.forEach(row => {
                const rowText = row.textContent.toLowerCase();
                const shouldShow = rowText.includes(searchTerm);
                
                if (shouldShow) {
                    // Highlight matching text
                    const cells = row.querySelectorAll('td');
                    cells.forEach(cell => {
                        if (!cell.querySelector('.btn-group')) { // Skip action column
                            const cellText = cell.innerHTML;
                            const regex = new RegExp(`(${searchTerm})`, 'gi');
                            cell.innerHTML = cellText.replace(regex, '<span class="quick-search-highlight">$1</span>');
                        }
                    });
                    
                    row.style.display = '';
                    tbody.appendChild(row);
                    visibleRows++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Show "no results" message if no matches
            let noResultsRow = tbody.querySelector('.no-results-row');
            if (visibleRows === 0 && !noResultsRow) {
                noResultsRow = document.createElement('tr');
                noResultsRow.className = 'no-results-row';
                noResultsRow.innerHTML = `
                    <td colspan="6" class="text-center py-4 text-muted">
                        <i class="fas fa-search fa-2x mb-2 d-block"></i>
                        No CDIC records match "${searchTerm}"
                    </td>
                `;
                tbody.appendChild(noResultsRow);
            } else if (visibleRows > 0 && noResultsRow) {
                noResultsRow.remove();
            }
        });
    }
    
    // Auto-expand search card if there are search parameters
    const urlParams = new URLSearchParams(window.location.search);
    const hasSearchParams = urlParams.has('search_patient') || urlParams.has('date_range') || 
                           urlParams.has('follow_up_status') || urlParams.has('created_by');
    
    if (hasSearchParams) {
        const searchCard = document.querySelector('.collapsed-card');
        if (searchCard) {
            searchCard.classList.remove('collapsed-card');
            searchCard.querySelector('.card-body').style.display = 'block';
            searchCard.querySelector('.card-tools .fa-plus').classList.replace('fa-plus', 'fa-minus');
        }
    }
    
    // Form submission handler to preserve search parameters
    const searchForm = document.getElementById('searchForm');
    if (searchForm) {
        searchForm.addEventListener('submit', function(e) {
            // Remove empty form fields to clean up URL
            const formData = new FormData(this);
            const cleanedData = new URLSearchParams();
            
            for (let [key, value] of formData.entries()) {
                if (value && value.trim() !== '') {
                    cleanedData.append(key, value);
                }
            }
            
            // Redirect with clean URL
            e.preventDefault();
            const newUrl = `${window.location.pathname}${cleanedData.toString() ? '?' + cleanedData.toString() : ''}`;
            window.location.href = newUrl;
        });
    }
    
    // Delete confirmation with enhanced UX
    document.querySelectorAll('[onclick*="confirm"]').forEach(link => {
        link.removeAttribute('onclick');
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (confirm('Are you sure you want to delete this CDIC record? This action cannot be undone.')) {
                window.location.href = this.href;
            }
        });
    });
    
    // Highlight overdue appointments
    document.querySelectorAll('.badge-danger').forEach(badge => {
        if (badge.textContent.includes('Overdue')) {
            badge.parentElement.parentElement.style.background = 'rgba(220, 53, 69, 0.05)';
        }
    });
});
</script>

{% endblock main_content %}
