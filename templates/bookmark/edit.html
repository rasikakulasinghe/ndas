{% extends 'src/base.html' %}
{% block title %}Bookmark - Edit{% endblock %}

{% block main_content %}

</br>
{% include 'src/form_error.html' %}

<div class="container-sm">
  <div class="card">
    <div class="card-header bg-warning">
      <h3 class="card-title"><i class="fas fa-edit mr-2"></i>Edit Bookmark</h3>
    </div>

    <form action="{% url 'bookmark-edit' bookmark.id %}" method="POST" novalidate>
      {% csrf_token %}

      <div class="card-body">

        <div class="form-group row">
          <label class="col-form-label col-sm-2">Bookmark Type : </label>
          <div class="col-sm-10">
            <span class="form-control-plaintext">
              <span class="badge badge-info">{{bookmark.bookmark_type}}</span>
            </span>
          </div>
        </div>

        <div class="form-group row">
          <label class="col-form-label col-sm-2" for="{{ form.title.id_for_label }}">
            Title <span class="text-danger">*</span> : 
          </label>
          <div class="col-sm-10">
            {{form.title}}
            {% if form.title.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.title.errors %}
                  <small class="text-danger">{{ error }}</small><br>
                {% endfor %}
              </div>
            {% endif %}
            <small class="form-text text-muted">Descriptive title for the bookmark (max 200 characters)</small>
          </div>
        </div>

        <div class="form-group row">
          <label class="col-form-label col-sm-2" for="{{ form.description.id_for_label }}">Description : </label>
          <div class="col-sm-10">
            {{form.description}}
            {% if form.description.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.description.errors %}
                  <small class="text-danger">{{ error }}</small><br>
                {% endfor %}
              </div>
            {% endif %}
            <small class="form-text text-muted">Detailed description of the bookmark (max 1000 characters)</small>
          </div>
        </div>

        <!-- Form-wide errors -->
        {% if form.non_field_errors %}
          <div class="alert alert-danger" role="alert">
            {% for error in form.non_field_errors %}
              {{ error }}<br>
            {% endfor %}
          </div>
        {% endif %}

        <div class="row justify-content-end align-items-center">
          <div class="col-auto m-2">
            <button type="submit" class="btn btn-warning">
              <i class="fas fa-save mr-2"></i>Update Bookmark
            </button>
          </div>
          <div class="col-auto m-2">
            <a href="{% url 'bookmark-view' pk=bookmark.id %}" class="btn btn-secondary">
              <i class="fas fa-times mr-2"></i>Cancel
            </a>
          </div>
        </div>

        </br>

      </div>

    </form>

    <!-- /.card-body -->
  </div>
  <!-- /.card -->
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add form validation
    const form = document.querySelector('form');
    const titleField = document.getElementById('{{ form.title.id_for_label }}');
    const descriptionField = document.getElementById('{{ form.description.id_for_label }}');

    // Real-time validation for title
    if (titleField) {
        titleField.addEventListener('input', function() {
            const value = this.value.trim();
            const feedback = this.parentNode.querySelector('.invalid-feedback');
            
            // Title validation
            if (!value || value.length < 2) {
                this.classList.add('is-invalid');
                if (!feedback) {
                    const div = document.createElement('div');
                    div.className = 'invalid-feedback d-block';
                    div.innerHTML = '<small class="text-danger">Title must be at least 2 characters long</small>';
                    this.parentNode.appendChild(div);
                }
            } else if (value.length > 200) {
                this.classList.add('is-invalid');
                if (!feedback) {
                    const div = document.createElement('div');
                    div.className = 'invalid-feedback d-block';
                    div.innerHTML = '<small class="text-danger">Title cannot exceed 200 characters</small>';
                    this.parentNode.appendChild(div);
                }
            } else if (!/^[a-zA-Z0-9\s\-_\.(),!?]+$/.test(value)) {
                this.classList.add('is-invalid');
                if (!feedback) {
                    const div = document.createElement('div');
                    div.className = 'invalid-feedback d-block';
                    div.innerHTML = '<small class="text-danger">Title can only contain letters, numbers, spaces, and basic punctuation</small>';
                    this.parentNode.appendChild(div);
                }
            } else {
                this.classList.remove('is-invalid');
                if (feedback && !feedback.innerHTML.includes('{{ form.title.errors|first }}')) {
                    feedback.remove();
                }
            }

            // Update character counter
            updateCharCounter(this, 200, 'title-counter');
        });
    }

    // Real-time validation for description
    if (descriptionField) {
        descriptionField.addEventListener('input', function() {
            const value = this.value.trim();
            
            if (value.length > 1000) {
                this.classList.add('is-invalid');
                const feedback = this.parentNode.querySelector('.invalid-feedback');
                if (!feedback) {
                    const div = document.createElement('div');
                    div.className = 'invalid-feedback d-block';
                    div.innerHTML = '<small class="text-danger">Description cannot exceed 1000 characters</small>';
                    this.parentNode.appendChild(div);
                }
            } else {
                this.classList.remove('is-invalid');
                const feedback = this.parentNode.querySelector('.invalid-feedback');
                if (feedback && !feedback.innerHTML.includes('{{ form.description.errors|first }}')) {
                    feedback.remove();
                }
            }

            // Update character counter
            updateCharCounter(this, 1000, 'desc-counter');
        });
    }

    // Character counter function
    function updateCharCounter(field, maxLength, counterId) {
        let counter = document.getElementById(counterId);
        if (!counter) {
            counter = document.createElement('div');
            counter.id = counterId;
            counter.className = 'char-counter text-muted small mt-1';
            field.parentNode.appendChild(counter);
        }
        const remaining = maxLength - field.value.length;
        counter.textContent = `${remaining} characters remaining`;
        counter.style.color = remaining < 50 ? '#dc3545' : '#6c757d';
    }

    // Initialize character counters
    if (titleField) updateCharCounter(titleField, 200, 'title-counter');
    if (descriptionField) updateCharCounter(descriptionField, 1000, 'desc-counter');

    // Form submission validation
    form.addEventListener('submit', function(e) {
        let hasError = false;

        // Validate required title field
        if (titleField && (!titleField.value || titleField.value.trim() === '')) {
            titleField.classList.add('is-invalid');
            hasError = true;
        } else if (titleField) {
            titleField.classList.remove('is-invalid');
        }

        if (hasError) {
            e.preventDefault();
            // Scroll to first error
            const firstError = form.querySelector('.is-invalid');
            if (firstError) {
                firstError.focus();
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });
});
</script>

<style>
.char-counter {
    text-align: right;
    margin-top: 5px;
}

.badge {
    font-size: 0.9em;
}

.form-control-plaintext {
    color: #495057 !important;
}
</style>

{% endblock main_content %}