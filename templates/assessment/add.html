{% extends 'src/base.html' %}
{% load static %}
{% block title %}Create Assessment - {{ patient.baby_name }}{% endblock %}

{% block main_content %}
<div class="container-fluid">
  <!-- Content Header -->
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0">Create GM Assessment</h1>
          <small class="text-muted">Patient: {{ patient.baby_name }}</small>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'view-patient' patient.id %}">{{ patient.baby_name }}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'video:view' file.id %}">{{ file.title }}</a></li>
            <li class="breadcrumb-item active">New Assessment</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <!-- Main content -->
  <section class="content">
    <div class="container-fluid">
      <div class="row">
        <!-- Patient & Video Information -->
        <div class="col-lg-4 col-md-6">
          <!-- Patient Info -->
          <div class="card card-primary">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-user mr-2"></i>Patient Information
              </h3>
            </div>
            <div class="card-body">
              <dl class="row">
                <dt class="col-sm-5">Baby Name:</dt>
                <dd class="col-sm-7">{{ patient.baby_name|default:"N/A" }}</dd>
                
                <dt class="col-sm-5">Mother Name:</dt>
                <dd class="col-sm-7">{{ patient.mother_name|default:"N/A" }}</dd>
                
                <dt class="col-sm-5">Gender:</dt>
                <dd class="col-sm-7">{{ patient.gender|default:"N/A" }}</dd>
                
                <dt class="col-sm-5">Current Age:</dt>
                <dd class="col-sm-7">{{ patient.getCurrentAge|default:"N/A" }}</dd>
                
                <dt class="col-sm-5">Corrected Age:</dt>
                <dd class="col-sm-7">{{ patient.getCorrectedAge|default:"N/A" }}</dd>
              </dl>
            </div>
          </div>

          <!-- Video Info -->
          <div class="card card-info">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-video mr-2"></i>Video Information
              </h3>
            </div>
            <div class="card-body">
              <dl class="row">
                <dt class="col-sm-5">Title:</dt>
                <dd class="col-sm-7">{{ file.title|default:"N/A" }}</dd>
                
                <dt class="col-sm-5">Recorded On:</dt>
                <dd class="col-sm-7">{{ file.recorded_on|date:"M d, Y"|default:"N/A" }}</dd>
                
                <dt class="col-sm-5">Age at Recording:</dt>
                <dd class="col-sm-7">{{ file.age_on_recording|default:"N/A" }}</dd>
                
                <dt class="col-sm-5">Duration:</dt>
                <dd class="col-sm-7">{{ file.duration_formatted|default:"N/A" }}</dd>
              </dl>
            </div>
          </div>

        </div>

        <!-- Assessment Form -->
        <div class="col-lg-8 col-md-6">
          <div class="card card-success">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-stethoscope mr-2"></i>GM Assessment Form
              </h3>
            </div>
            <form id="assessment-form" method="post">
              {% csrf_token %}
              
              <div class="card-body">
                <!-- Assessment Date -->
                <div class="form-group">
                  <label for="{{ form.date_of_assessment.id_for_label }}">
                    <i class="fas fa-calendar mr-2"></i>{{ form.date_of_assessment.label }}
                  </label>
                  {{ form.date_of_assessment }}
                  <small class="form-text text-muted">{{ form.date_of_assessment.help_text|default:"Date and time when this assessment was performed" }}</small>
                  {% if form.date_of_assessment.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in form.date_of_assessment.errors %}{{ error }}{% endfor %}
                    </div>
                  {% endif %}
                </div>

                <!-- Diagnosis Selection Section -->
                <div class="form-group">
                  <div class="card card-outline card-warning mb-3">
                    <div class="card-header py-2" data-toggle="collapse" data-target="#diagnosisCard" 
                         aria-expanded="false" aria-controls="diagnosisCard" style="cursor: pointer; user-select: none;">
                      <h5 class="card-title mb-0 d-flex align-items-center justify-content-between">
                        <span>
                          <i class="fas fa-diagnoses mr-2 text-warning"></i>{{ form.diagnosis.label }}
                        </span>
                        <i class="fas fa-plus" id="diagnosisToggleIcon" style="transition: transform 0.2s;"></i>
                      </h5>
                    </div>
                    <div id="diagnosisCard" class="collapse">
                      <div class="card-body pt-3">
                        <div class="diagnosis-options">
                          {{ form.diagnosis }}
                        </div>
                        {% if form.diagnosis.errors %}
                          <div class="invalid-feedback d-block mt-2">
                            {% for error in form.diagnosis.errors %}{{ error }}{% endfor %}
                          </div>
                        {% endif %}
                        
                        <!-- Other Diagnosis Toggle -->
                        <div class="form-check mt-3 pt-2 border-top">
                          <input class="form-check-input" type="checkbox" id="otherDiagnosisToggle">
                          <label class="form-check-label" for="otherDiagnosisToggle">
                            <i class="fas fa-plus-circle mr-1 text-info"></i>Other (specify below)
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Other Diagnosis -->
                <div class="form-group" id="otherDiagnosisGroup" style="display: none;">
                  <label for="{{ form.diagnosis_other.id_for_label }}">
                    <i class="fas fa-edit mr-2"></i>{{ form.diagnosis_other.label }}
                  </label>
                  {{ form.diagnosis_other }}
                  <small class="form-text text-muted">{{ form.diagnosis_other.help_text|default:"Additional diagnosis notes not covered by standard list" }}</small>
                  {% if form.diagnosis_other.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in form.diagnosis_other.errors %}{{ error }}{% endfor %}
                    </div>
                  {% endif %}
                </div>

                <!-- Diagnosis Conclusion -->
                <div class="form-group">
                  <label for="{{ form.diagnosis_conclusion.id_for_label }}">
                    <i class="fas fa-clipboard-check mr-2"></i>{{ form.diagnosis_conclusion.label }}
                  </label>
                  {{ form.diagnosis_conclusion }}
                  <small class="form-text text-muted">{{ form.diagnosis_conclusion.help_text|default:"Overall assessment conclusion" }}</small>
                  {% if form.diagnosis_conclusion.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in form.diagnosis_conclusion.errors %}{{ error }}{% endfor %}
                    </div>
                  {% endif %}
                </div>

                <!-- Management Plan -->
                <div class="form-group">
                  <label for="{{ form.management_plan.id_for_label }}">
                    <i class="fas fa-tasks mr-2"></i>{{ form.management_plan.label }}
                  </label>
                  {{ form.management_plan }}
                  <small class="form-text text-muted">{{ form.management_plan.help_text|default:"Recommended treatment and intervention plan" }}</small>
                  {% if form.management_plan.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in form.management_plan.errors %}{{ error }}{% endfor %}
                    </div>
                  {% endif %}
                </div>

                <!-- Next Assessment Date -->
                <div class="form-group">
                  <label for="{{ form.next_assessment_date.id_for_label }}">
                    <i class="fas fa-calendar-plus mr-2"></i>{{ form.next_assessment_date.label }}
                  </label>
                  {{ form.next_assessment_date }}
                  <small class="form-text text-muted">{{ form.next_assessment_date.help_text|default:"Scheduled date for follow-up assessment (optional)" }}</small>
                  {% if form.next_assessment_date.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in form.next_assessment_date.errors %}{{ error }}{% endfor %}
                    </div>
                  {% endif %}
                </div>

                <!-- Parent Informed -->
                <div class="form-group">
                  <div class="form-check">
                    {{ form.parent_informed }}
                    <label class="form-check-label" for="{{ form.parent_informed.id_for_label }}">
                      <i class="fas fa-info-circle mr-2"></i>{{ form.parent_informed.label }}
                    </label>
                  </div>
                  <small class="form-text text-muted">{{ form.parent_informed.help_text|default:"Check if the parent has been informed of the assessment results" }}</small>
                  {% if form.parent_informed.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in form.parent_informed.errors %}{{ error }}{% endfor %}
                    </div>
                  {% endif %}
                </div>

                <!-- Progress indicator (hidden initially) -->
                <div id="save-progress" class="d-none">
                  <div class="form-group">
                    <label>Saving Assessment:</label>
                    <div class="progress">
                      <div class="progress-bar progress-bar-striped progress-bar-animated" 
                           id="progress-bar" 
                           role="progressbar" 
                           style="width: 0%">
                        0%
                      </div>
                    </div>
                    <small id="progress-text" class="form-text text-muted">Processing assessment...</small>
                  </div>
                </div>
              </div>

              <div class="card-footer">
                <div class="row">
                  <div class="col-sm-6">
                    <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                      <i class="fas fa-arrow-left mr-2"></i>Back
                    </button>
                  </div>
                  <div class="col-sm-6 text-right">
                    <button type="submit" id="save-btn" class="btn btn-success">
                      <i class="fas fa-save mr-2"></i>Create Assessment
                    </button>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('assessment-form');
    const saveBtn = document.getElementById('save-btn');
    const progressDiv = document.getElementById('save-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const otherDiagnosisToggle = document.getElementById('otherDiagnosisToggle');
    const otherDiagnosisGroup = document.getElementById('otherDiagnosisGroup');
    const diagnosisCard = document.getElementById('diagnosisCard');
    const diagnosisToggleIcon = document.getElementById('diagnosisToggleIcon');
    
    let currentXHR = null;
    
    // Toggle other diagnosis field
    if (otherDiagnosisToggle && otherDiagnosisGroup) {
        otherDiagnosisToggle.addEventListener('change', function() {
            if (this.checked) {
                otherDiagnosisGroup.style.display = 'block';
                otherDiagnosisGroup.querySelector('textarea').focus();
            } else {
                otherDiagnosisGroup.style.display = 'none';
                otherDiagnosisGroup.querySelector('textarea').value = '';
            }
        });
    }
    
    // Handle diagnosis card collapse with + and - icons
    if (diagnosisCard && diagnosisToggleIcon) {
        diagnosisCard.addEventListener('show.bs.collapse', function() {
            diagnosisToggleIcon.classList.remove('fa-plus');
            diagnosisToggleIcon.classList.add('fa-minus');
        });
        
        diagnosisCard.addEventListener('hide.bs.collapse', function() {
            diagnosisToggleIcon.classList.remove('fa-minus');
            diagnosisToggleIcon.classList.add('fa-plus');
        });
    }
    
    // Handle form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!validateForm()) {
            return;
        }
        
        const formData = new FormData(form);
        saveAssessment(formData);
    });
    
    function validateForm() {
        let isValid = true;
        
        // Clear previous validation states
        form.querySelectorAll('.is-invalid').forEach(element => {
            element.classList.remove('is-invalid');
        });
        form.querySelectorAll('.custom-error-message').forEach(element => {
            element.remove();
        });
        
        // Assessment Date validation
        const assessmentDate = form.querySelector('[name="date_of_assessment"]');
        if (!assessmentDate.value.trim()) {
            showFieldError(assessmentDate, 'Assessment date is required');
            isValid = false;
        } else {
            // Check if assessment date is not in the future
            const now = new Date();
            const selectedDate = new Date(assessmentDate.value);
            if (selectedDate > now) {
                showFieldError(assessmentDate, 'Assessment date cannot be in the future');
                isValid = false;
            }
        }
        
        // Diagnosis validation
        const diagnosisCheckboxes = document.querySelectorAll('input[name="diagnosis"]:checked');
        const diagnosisOther = document.querySelector('textarea[name="diagnosis_other"]');
        
        if (diagnosisCheckboxes.length === 0 && (!diagnosisOther || !diagnosisOther.value.trim())) {
            const diagnosisContainer = document.querySelector('#diagnosisCard');
            if (diagnosisContainer) {
                showFieldError(diagnosisContainer, 'Please select at least one diagnosis or provide other diagnosis');
                // Auto-expand diagnosis section to show error
                if (diagnosisCard && !diagnosisCard.classList.contains('show')) {
                    $(diagnosisCard).collapse('show');
                }
            }
            isValid = false;
        }
        
        // Diagnosis Conclusion validation
        const diagnosisConclusion = form.querySelector('[name="diagnosis_conclusion"]');
        if (diagnosisConclusion && !diagnosisConclusion.value.trim()) {
            showFieldError(diagnosisConclusion, 'Diagnosis conclusion is required');
            isValid = false;
        }
        
        // Management Plan validation
        const managementPlan = form.querySelector('[name="management_plan"]');
        if (managementPlan && !managementPlan.value.trim()) {
            showFieldError(managementPlan, 'Management plan is required');
            isValid = false;
        }
        
        if (!isValid) {
            showAlert('Please correct the validation errors below', 'danger');
            // Scroll to first error
            const firstError = form.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }
        }
        
        return isValid;
    }
    
    function showFieldError(field, message) {
        field.classList.add('is-invalid');
        
        // Create or update error message
        let errorDiv = field.parentNode.querySelector('.custom-error-message');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.className = 'invalid-feedback d-block custom-error-message';
            field.parentNode.appendChild(errorDiv);
        }
        errorDiv.textContent = message;
    }
    
    function saveAssessment(formData) {
        currentXHR = new XMLHttpRequest();
        
        // Show progress and disable form
        progressDiv.classList.remove('d-none');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
        
        // Simulate progress
        progressBar.style.width = '25%';
        progressBar.textContent = '25%';
        progressText.textContent = 'Validating assessment data...';
        
        // Handle successful response
        currentXHR.addEventListener('load', function() {
            progressBar.style.width = '100%';
            progressBar.textContent = '100%';
            progressText.textContent = 'Processing complete...';
            
            if (currentXHR.status === 200) {
                try {
                    const response = JSON.parse(currentXHR.responseText);
                    
                    if (response.success) {
                        handleSaveSuccess(response);
                    } else {
                        handleSaveError(response.errors || response.msg || 'Save failed');
                    }
                } catch (e) {
                    // Handle non-AJAX responses (regular form submission success)
                    if (currentXHR.responseText.includes('<!DOCTYPE html>')) {
                        // Redirect happened, parse for redirect URL or reload
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = currentXHR.responseText;
                        const successMessage = tempDiv.querySelector('.alert-success');
                        if (successMessage) {
                            showAlert('Assessment created successfully!', 'success');
                            setTimeout(() => {
                                window.location.href = '/assessment/view/' + 'PLACEHOLDER' + '/';
                            }, 1500);
                            return;
                        }
                    }
                    console.error('Error parsing response:', e);
                    handleSaveError('Invalid server response');
                }
            } else {
                handleSaveError('Server error: ' + currentXHR.status);
            }
        });
        
        // Handle save errors
        currentXHR.addEventListener('error', function() {
            handleSaveError('Network error occurred during save');
        });
        
        // Progress simulation
        setTimeout(() => {
            progressBar.style.width = '50%';
            progressBar.textContent = '50%';
            progressText.textContent = 'Saving assessment...';
        }, 500);
        
        setTimeout(() => {
            progressBar.style.width = '75%';
            progressBar.textContent = '75%';
            progressText.textContent = 'Finalizing...';
        }, 1000);
        
        // Start save
        currentXHR.open('POST', form.action || window.location.pathname);
        currentXHR.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        currentXHR.send(formData);
    }
    
    function handleSaveSuccess(response) {
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add('bg-success');
        progressText.textContent = 'Assessment created successfully!';
        
        showAlert('Assessment created successfully!', 'success');
        
        // Redirect after a short delay
        setTimeout(() => {
            if (response.redirect_url) {
                window.location.href = response.redirect_url;
            } else {
                window.location.href = '/assessment/view/' + response.assessment_id + '/';
            }
        }, 1500);
    }
    
    function handleSaveError(errors) {
        resetSaveState();
        
        let errorMessage = 'Failed to create assessment. ';
        if (typeof errors === 'object') {
            // Handle field-specific errors
            for (const [field, errorList] of Object.entries(errors)) {
                if (field !== 'general') {
                    const fieldElement = form.querySelector(`[name="${field}"]`);
                    if (fieldElement) {
                        fieldElement.classList.add('is-invalid');
                    }
                }
                errorMessage += errorList.join(' ');
            }
        } else {
            errorMessage += errors;
        }
        
        showAlert(errorMessage, 'danger');
    }
    
    function resetSaveState() {
        progressDiv.classList.add('d-none');
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Create Assessment';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        progressBar.classList.add('progress-bar-animated');
        progressBar.classList.remove('bg-success');
        progressText.textContent = 'Processing assessment...';
        currentXHR = null;
        
        // Clear form validation states
        form.querySelectorAll('.is-invalid').forEach(element => {
            element.classList.remove('is-invalid');
        });
    }
    
    function showAlert(message, type) {
        // Remove any existing alerts
        const existingAlerts = document.querySelectorAll('.assessment-alert');
        existingAlerts.forEach(alert => alert.remove());
        
        // Create new alert
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible assessment-alert`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        `;
        
        // Insert alert at the top of the form
        const cardBody = form.querySelector('.card-body');
        cardBody.insertBefore(alert, cardBody.firstChild);
        
        // Auto-dismiss after 5 seconds for success messages
        if (type === 'success') {
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
    }
    
    // Initialize tooltips if available
    if (typeof $().tooltip === 'function') {
        $('[data-toggle="tooltip"]').tooltip();
    }
    
    // Initialize Bootstrap collapse if available
    if (typeof $().collapse === 'function') {
        $('.collapse').collapse('hide');
    }
    
    // Set default assessment date to now
    const assessmentDateInput = form.querySelector('[name="date_of_assessment"]');
    if (assessmentDateInput && !assessmentDateInput.value) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        
        assessmentDateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }
});
</script>

<style>
.diagnosis-options ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.diagnosis-options li {
    margin-bottom: 8px;
    padding: 5px 0;
}

.diagnosis-options input[type="checkbox"] {
    margin-right: 8px;
}

.diagnosis-options label {
    font-weight: normal;
    margin-bottom: 0;
    cursor: pointer;
    display: flex;
    align-items: center;
}

.card-outline.card-warning {
    border-color: #ffc107;
}

.card-outline.card-warning .card-header {
    background-color: rgba(255, 193, 7, 0.1);
    border-bottom: 1px solid #ffc107;
}

#diagnosisToggleIcon {
    font-size: 14px;
    color: #6c757d;
}

.diagnosis-options .form-check {
    padding-left: 0;
}

.diagnosis-options .form-check-input {
    margin-left: 0;
    margin-top: 0.125rem;
}
</style>

{% endblock main_content %}