{% extends 'src/base.html' %}
{% load static %}
{% block title %}Upload Video - {{ patient.baby_name }}{% endblock %}

{% block main_content %}
<div class="container-fluid">
  <!-- Content Header -->
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0">Upload Video</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'view-patient' patient.id %}">{{ patient.baby_name }}</a></li>
            <li class="breadcrumb-item active">Upload Video</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <!-- Main content -->
  <section class="content">
    <div class="container-fluid">
      <div class="row">
        <!-- Patient Information -->
        <div class="col-lg-4 col-md-6">
          <div class="card card-primary">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-user mr-2"></i>Patient Information
              </h3>
            </div>
            <div class="card-body">
              <dl class="row">
                <dt class="col-sm-5">BHT:</dt>
                <dd class="col-sm-7">{{ patient.bht|default:"N/A" }}</dd>
                
                <dt class="col-sm-5">PHN:</dt>
                <dd class="col-sm-7">{{ patient.pin|default:"N/A" }}</dd>
                
                <dt class="col-sm-5">NNC No:</dt>
                <dd class="col-sm-7">{{ patient.nnc_no|default:"N/A" }}</dd>
                
                <dt class="col-sm-5">Baby Name:</dt>
                <dd class="col-sm-7">{{ patient.baby_name|default:"N/A" }}</dd>
                
                <dt class="col-sm-5">Mother Name:</dt>
                <dd class="col-sm-7">{{ patient.mother_name|default:"N/A" }}</dd>
                
                <dt class="col-sm-5">Gender:</dt>
                <dd class="col-sm-7">{{ patient.gender|default:"N/A" }}</dd>
                
                <dt class="col-sm-5">Current Age:</dt>
                <dd class="col-sm-7">{{ patient.getCurrentAge|default:"N/A" }}</dd>
              </dl>
            </div>
          </div>
        </div>

        <!-- Upload Form -->
        <div class="col-lg-8 col-md-6">
          <div class="card card-success">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-cloud-upload-alt mr-2"></i>Video Upload
              </h3>
            </div>
            <form id="video-upload-form" method="post" enctype="multipart/form-data">
              {% csrf_token %}

              <div class="card-body">
                <!-- Video Title -->
                <div class="form-group">
                  <label for="{{ video_form.title.id_for_label }}">
                    <i class="fas fa-tag mr-2"></i>{{ video_form.title.label }}
                  </label>
                  {{ video_form.title }}
                  <small class="form-text text-muted">{{ video_form.title.help_text }}</small>
                  {% if video_form.title.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in video_form.title.errors %}{{ error }}{% endfor %}
                    </div>
                  {% endif %}
                </div>

                <!-- Video File Upload -->
                <div class="form-group">
                  <label for="{{ video_form.video_file.id_for_label }}">
                    <i class="fas fa-video mr-2"></i>{{ video_form.video_file.label }}
                  </label>
                  <div class="custom-file">
                    {{ video_form.video_file }}
                    <label class="custom-file-label" for="{{ video_form.video_file.id_for_label }}">
                      Choose video file...
                    </label>
                  </div>
                  <small class="form-text text-muted">{{ video_form.video_file.help_text }}</small>
                  {% if video_form.video_file.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in video_form.video_file.errors %}{{ error }}{% endfor %}
                    </div>
                  {% endif %}
                </div>

                <!-- Recording Date -->
                <div class="form-group">
                  <label for="{{ video_form.recorded_on.id_for_label }}">
                    <i class="fas fa-calendar mr-2"></i>{{ video_form.recorded_on.label }}
                  </label>
                  {{ video_form.recorded_on }}
                  <small class="form-text text-muted">{{ video_form.recorded_on.help_text }}</small>
                  {% if video_form.recorded_on.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in video_form.recorded_on.errors %}{{ error }}{% endfor %}
                    </div>
                  {% endif %}
                </div>

                <!-- Description -->
                <div class="form-group">
                  <label for="{{ video_form.description.id_for_label }}">
                    <i class="fas fa-comment-alt mr-2"></i>{{ video_form.description.label }}
                  </label>
                  {{ video_form.description }}
                  <small class="form-text text-muted">{{ video_form.description.help_text }}</small>
                  {% if video_form.description.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in video_form.description.errors %}{{ error }}{% endfor %}
                    </div>
                  {% endif %}
                </div>

                <!-- Upload Progress -->
                <div id="upload-progress" class="d-none">
                  <div class="form-group">
                    <label>Upload Progress:</label>
                    <div class="progress">
                      <div class="progress-bar progress-bar-striped progress-bar-animated" 
                           id="progress-bar" 
                           role="progressbar" 
                           style="width: 0%">
                        0%
                      </div>
                    </div>
                    <small id="progress-text" class="form-text text-muted">Preparing upload...</small>
                  </div>
                </div>

                <!-- Processing Status -->
                <div id="processing-status" class="alert alert-info d-none">
                  <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm mr-2" role="status">
                      <span class="sr-only">Processing...</span>
                    </div>
                    <span>Processing video... Please wait.</span>
                  </div>
                </div>
              </div>

              <div class="card-footer">
                <div class="row">
                  <div class="col-sm-6">
                    <button type="button" id="cancel-upload" class="btn btn-outline-danger d-none">
                      <i class="fas fa-times mr-2"></i>Cancel Upload
                    </button>
                  </div>
                  <div class="col-sm-6 text-right">
                    <button type="button" class="btn btn-secondary mr-2" onclick="window.history.back()">
                      <i class="fas fa-arrow-left mr-2"></i>Back
                    </button>
                    <button type="submit" id="upload-btn" class="btn btn-success">
                      <i class="fas fa-cloud-upload-alt mr-2"></i>Upload Video
                    </button>
                    <button type="button" id="view-btn" class="btn btn-primary d-none">
                      <i class="fas fa-eye mr-2"></i>View Video
                    </button>
                    <button type="button" id="add-another-btn" class="btn btn-outline-primary d-none">
                      <i class="fas fa-plus mr-2"></i>Add Another
                    </button>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('video-upload-form');
    const fileInput = form.querySelector('input[type="file"]');
    const fileLabel = form.querySelector('.custom-file-label');
    const uploadBtn = document.getElementById('upload-btn');
    const cancelBtn = document.getElementById('cancel-upload');
    const viewBtn = document.getElementById('view-btn');
    const addAnotherBtn = document.getElementById('add-another-btn');
    const progressDiv = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const processingStatus = document.getElementById('processing-status');
    
    let currentXHR = null;
    
    // Update file label when file is selected
    fileInput.addEventListener('change', function() {
        const fileName = this.files[0] ? this.files[0].name : 'Choose video file...';
        fileLabel.textContent = fileName;
        
        // Basic client-side validation
        if (this.files[0]) {
            const file = this.files[0];
            const maxSize = 500 * 1024 * 1024; // 500MB
            
            if (file.size > maxSize) {
                showAlert('File size too large. Maximum allowed size is 500MB.', 'danger');
                this.value = '';
                fileLabel.textContent = 'Choose video file...';
                return;
            }
            
            // Check file type
            const allowedTypes = ['video/mp4', 'video/avi', 'video/mov', 'video/wmv', 'video/mkv', 'video/webm'];
            if (!allowedTypes.includes(file.type) && !file.name.match(/\.(mp4|avi|mov|wmv|mkv|webm)$/i)) {
                showAlert('Invalid file type. Please upload MP4, AVI, MOV, WMV, MKV, or WEBM files only.', 'danger');
                this.value = '';
                fileLabel.textContent = 'Choose video file...';
                return;
            }
        }
    });
    
    // Handle form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!validateForm()) {
            return;
        }
        
        const formData = new FormData(form);
        uploadVideo(formData);
    });
    
    // Handle upload cancellation
    cancelBtn.addEventListener('click', function() {
        if (currentXHR) {
            currentXHR.abort();
            resetUploadState();
            showAlert('Upload cancelled by user.', 'warning');
        }
    });
    
    function validateForm() {
        const title = form.querySelector('[name="title"]').value.trim();
        const videoFile = fileInput.files[0];
        const recordedOn = form.querySelector('[name="recorded_on"]').value;
        
        if (!title) {
            showAlert('Please enter a video title.', 'danger');
            return false;
        }
        
        if (!videoFile) {
            showAlert('Please select a video file.', 'danger');
            return false;
        }
        
        if (!recordedOn) {
            showAlert('Please select the recording date.', 'danger');
            return false;
        }
        
        return true;
    }
    
    function uploadVideo(formData) {
        currentXHR = new XMLHttpRequest();
        
        // Show progress bar and hide upload button
        progressDiv.classList.remove('d-none');
        uploadBtn.classList.add('d-none');
        cancelBtn.classList.remove('d-none');
        
        // Upload progress tracking
        currentXHR.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percentComplete + '%';
                progressBar.textContent = percentComplete + '%';
                
                const loadedMB = Math.round(e.loaded / 1024 / 1024);
                const totalMB = Math.round(e.total / 1024 / 1024);
                progressText.textContent = `Uploading: ${loadedMB}MB / ${totalMB}MB (${percentComplete}%)`;
                
                if (percentComplete === 100) {
                    progressText.textContent = 'Upload complete. Processing video...';
                    processingStatus.classList.remove('d-none');
                }
            }
        });
        
        // Handle successful response
        currentXHR.addEventListener('load', function() {
            processingStatus.classList.add('d-none');
            
            if (currentXHR.status === 200) {
                try {
                    const response = JSON.parse(currentXHR.responseText);
                    
                    if (response.success) {
                        handleUploadSuccess(response);
                    } else {
                        handleUploadError(response.errors || 'Upload failed');
                    }
                } catch (e) {
                    console.error('Error parsing response:', e);
                    handleUploadError('Invalid server response');
                }
            } else {
                handleUploadError('Server error: ' + currentXHR.status);
            }
        });
        
        // Handle upload errors
        currentXHR.addEventListener('error', function() {
            processingStatus.classList.add('d-none');
            handleUploadError('Network error occurred during upload');
        });
        
        // Handle upload abortion
        currentXHR.addEventListener('abort', function() {
            processingStatus.classList.add('d-none');
            // Upload was cancelled - handled in cancel button click
        });
        
        // Start upload
        currentXHR.open('POST', '{% url "video:add" patient.id %}');
        currentXHR.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        currentXHR.send(formData);
    }
    
    function handleUploadSuccess(response) {
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add('bg-success');
        progressText.textContent = 'Video uploaded successfully!';
        
        // Show success buttons
        cancelBtn.classList.add('d-none');
        viewBtn.classList.remove('d-none');
        addAnotherBtn.classList.remove('d-none');
        
        // Set up view button
        viewBtn.onclick = function() {
            if (response.redirect_url) {
                window.location.href = response.redirect_url;
            } else {
                window.location.href = `/video/view/${response.f_id}/`;
            }
        };
        
        // Set up add another button
        addAnotherBtn.onclick = function() {
            window.location.reload();
        };
        
        showAlert('Video uploaded successfully!', 'success');
    }
    
    function handleUploadError(errors) {
        resetUploadState();
        
        let errorMessage = 'Upload failed. ';
        if (typeof errors === 'object') {
            errorMessage += Object.values(errors).flat().join(' ');
        } else {
            errorMessage += errors;
        }
        
        showAlert(errorMessage, 'danger');
    }
    
    function resetUploadState() {
        progressDiv.classList.add('d-none');
        processingStatus.classList.add('d-none');
        uploadBtn.classList.remove('d-none');
        cancelBtn.classList.add('d-none');
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        progressBar.classList.add('progress-bar-animated');
        progressBar.classList.remove('bg-success');
        progressText.textContent = 'Preparing upload...';
        currentXHR = null;
    }
    
    function showAlert(message, type) {
        // Remove any existing alerts
        const existingAlerts = document.querySelectorAll('.upload-alert');
        existingAlerts.forEach(alert => alert.remove());
        
        // Create new alert
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible upload-alert`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        `;
        
        // Insert alert at the top of the form
        const cardBody = form.querySelector('.card-body');
        cardBody.insertBefore(alert, cardBody.firstChild);
        
        // Auto-dismiss after 5 seconds for success messages
        if (type === 'success') {
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
    }
});
</script>

{% endblock main_content %}