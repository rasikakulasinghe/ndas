{% extends 'src/base.html' %}
{% load static %}
{% block title %}Video - Manager{% endblock %}
{% block main_content %}

<br>

<div class="container">
  
  <!-- Search and Filter Section -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h4 class="card-title mb-0">
        <i class="fas fa-video"></i> Video Manager 
        {% if patient %} :: {{patient.baby_name}}{% endif %}
        {% if total_count %}<span class="badge badge-light ml-2">{{total_count}} videos</span>{% endif %}
      </h4>
    </div>
    <div class="card-body">
      <form method="get" class="row">
        <div class="col-md-3 mb-2">
          <input type="text" name="search" class="form-control" placeholder="Search videos..." value="{{search_query}}">
        </div>
        <div class="col-md-2 mb-2">
          <select name="status" class="form-control">
            <option value="">All Statuses</option>
            {% for status_value, status_label in status_choices %}
              <option value="{{status_value}}" {% if status_filter == status_value %}selected{% endif %}>{{status_label}}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2 mb-2">
          <select name="patient" class="form-control">
            <option value="">All Patients</option>
            {% for p in patients %}
              <option value="{{p.id}}" {% if patient_filter == p.id|stringformat:"s" %}selected{% endif %}>{{p.baby_name}}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2 mb-2">
          <input type="date" name="date_from" class="form-control" placeholder="From Date" value="{{date_from}}">
        </div>
        <div class="col-md-2 mb-2">
          <input type="date" name="date_to" class="form-control" placeholder="To Date" value="{{date_to}}">
        </div>
        <div class="col-md-1 mb-2">
          <button type="submit" class="btn btn-primary btn-block">
            <i class="fas fa-search"></i>
          </button>
        </div>
      </form>
    </div>
  </div>

  {% if file_list %}

  <!-- Identification Details -->
  {% if patient %}{% include 'patients/partials/patient_identification_details.html' %}{% endif %}

  <div class="card">
    <div class="card-header bg-info">
      <h5 class="card-title mb-0">
        <i class="fas fa-list"></i> Video List
        <small class="text-muted">(Page {{file_list.number}} of {{file_list.paginator.num_pages}})</small>
      </h5>
    </div>

<div class="table-responsive">
<table class="table table-hover table-striped">
  <thead class="thead-dark">
    <tr>
      <th scope="col" style="width: 5%">ID</th>
      <th scope="col" style="width: 10%">Status</th>
      <th scope="col" style="width: 15%">Patient</th>
      <th scope="col" style="width: 15%">Title</th>
      <th scope="col" style="width: 10%">Duration</th>
      <th scope="col" style="width: 10%">Size</th>
      <th scope="col" style="width: 10%">Recorded</th>
      <th scope="col" style="width: 10%">Uploaded</th>
      <th scope="col" style="width: 10%">By</th>
      <th scope="col" style="width: 5%">Action</th>
    </tr>
  </thead>
  <tbody>
    {% for video in file_list %}
    <tr>
      <th scope="row">{{ video.id }}</th>
      
      <td>
        <div class="d-flex align-items-center">
          <!-- Processing Status Badge -->
          {% if video.processing_status == 'completed' %}
            <span class="badge badge-success" data-toggle="tooltip" title="Processing Complete">
              <i class="fas fa-check"></i> Ready
            </span>
          {% elif video.processing_status == 'processing' %}
            <span class="badge badge-warning" data-toggle="tooltip" title="Processing">
              <i class="fas fa-spinner fa-spin"></i> Processing
            </span>
          {% elif video.processing_status == 'failed' %}
            <span class="badge badge-danger" data-toggle="tooltip" title="Processing Failed">
              <i class="fas fa-times"></i> Failed
            </span>
          {% else %}
            <span class="badge badge-secondary" data-toggle="tooltip" title="Pending Processing">
              <i class="fas fa-clock"></i> Pending
            </span>
          {% endif %}
          
          <!-- Assessment Status -->
          <div class="ml-2">
            {% if video.is_new_file %}
              <span class="badge badge-danger" data-toggle="tooltip" title="New - Not used in assessment">New</span>
            {% else %}
              <i class="fas fa-check-circle text-success" data-toggle="tooltip" title="Used in assessment"></i>
            {% endif %}
          </div>
          
          <!-- Bookmark Status -->
          {% if video.is_bookmarked %}
            <div class="ml-2">
              <a href="{% url 'bookmark-view' video.get_bookmark.id %}" class="text-primary" data-toggle="tooltip" title="Bookmarked">
                <i class="fas fa-bookmark"></i>
              </a>
            </div>
          {% endif %}
        </div>
      </td>
      
      <td>
        <strong>{{video.patient.baby_name}}</strong><br>
        <small class="text-muted">{{video.patient.file_no|default:"No file #"}}</small>
      </td>
      
      <td>
        <div data-toggle="tooltip" title="{{video.description|default:'No description'}}">
          {{video.title|truncatechars:30}}
        </div>
        {% if video.description %}
          <small class="text-muted">{{video.description|truncatechars:50}}</small>
        {% endif %}
      </td>

      <td>
        <i class="fas fa-play-circle text-danger" data-toggle="tooltip" title="Video File"></i>
        <span class="ml-1">{{video.duration_formatted}}</span>
        {% if video.resolution != "Unknown" %}
          <br><small class="text-muted">{{video.resolution}}</small>
        {% endif %}
      </td>

      <td>
        <span>{{video.file_size_mb}} MB</span>
        {% if video.file_extension %}
          <br><small class="text-muted">{{video.file_extension|upper}}</small>
        {% endif %}
      </td>

      <td>
        {{video.recorded_on|date:"M d, Y"}}
        <br><small class="text-muted">{{video.recorded_on|date:"H:i"}}</small>
        {% if video.age_on_recording %}
          <br><small class="text-info">{{video.age_on_recording}}</small>
        {% endif %}
      </td>
      
      <td>
        {{video.created_at|date:"M d, Y"}}
        <br><small class="text-muted">{{video.created_at|date:"H:i"}}</small>
      </td>
      
      <td>
        {{video.added_by.get_full_name|default:video.added_by.username}}
        {% if video.updated_by and video.updated_by != video.added_by %}
          <br><small class="text-muted">Modified by: {{video.updated_by.username}}</small>
        {% endif %}
      </td>
      
      <td>
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-ellipsis-v"></i>
          </button>
          <div class="dropdown-menu dropdown-menu-right">
            <a class="dropdown-item" href="{% url 'video:view' video.id %}">
              <i class="fas fa-eye text-primary"></i> View/Play
            </a>
            <a class="dropdown-item" href="{% url 'video:edit' video.id %}">
              <i class="fas fa-edit text-warning"></i> Edit Details
            </a>
            <a class="dropdown-item" href="{% url 'video:delete-confirm' video.id %}">
              <i class="fas fa-trash-alt text-danger"></i> Delete
            </a>
            <div class="dropdown-divider"></div>
            {% if video.is_new_file %}
              <a class="dropdown-item" href="{% url 'assessment-add' video.patient.id video.id %}">
                <i class="fas fa-plus-circle text-success"></i> New Assessment
              </a>
            {% else %}
              <a class="dropdown-item" href="{% url 'assessment-view-by-file-id' video.id %}">
                <i class="fas fa-eye text-info"></i> View Assessment
              </a>
            {% endif %}
            <a class="dropdown-item" href="{% url 'view-patient' video.patient.id %}">
              <i class="fas fa-user text-info"></i> View Patient
            </a>
          </div>
        </div>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>

</div>

      <!-- Pagination -->
      {% if file_list.paginator.num_pages > 1 %}
      <nav aria-label="Video pagination" class="mt-4">
        <ul class="pagination justify-content-center">
          {% if file_list.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page=1{% if search_query %}&search={{search_query}}{% endif %}{% if status_filter %}&status={{status_filter}}{% endif %}{% if patient_filter %}&patient={{patient_filter}}{% endif %}{% if date_from %}&date_from={{date_from}}{% endif %}{% if date_to %}&date_to={{date_to}}{% endif %}">&laquo; First</a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ file_list.previous_page_number }}{% if search_query %}&search={{search_query}}{% endif %}{% if status_filter %}&status={{status_filter}}{% endif %}{% if patient_filter %}&patient={{patient_filter}}{% endif %}{% if date_from %}&date_from={{date_from}}{% endif %}{% if date_to %}&date_to={{date_to}}{% endif %}">Previous</a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">&laquo; First</span>
            </li>
            <li class="page-item disabled">
              <span class="page-link">Previous</span>
            </li>
          {% endif %}
          
          <li class="page-item active">
            <span class="page-link">
              Page {{ file_list.number }} of {{ file_list.paginator.num_pages }}
            </span>
          </li>
          
          {% if file_list.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ file_list.next_page_number }}{% if search_query %}&search={{search_query}}{% endif %}{% if status_filter %}&status={{status_filter}}{% endif %}{% if patient_filter %}&patient={{patient_filter}}{% endif %}{% if date_from %}&date_from={{date_from}}{% endif %}{% if date_to %}&date_to={{date_to}}{% endif %}">Next</a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ file_list.paginator.num_pages }}{% if search_query %}&search={{search_query}}{% endif %}{% if status_filter %}&status={{status_filter}}{% endif %}{% if patient_filter %}&patient={{patient_filter}}{% endif %}{% if date_from %}&date_from={{date_from}}{% endif %}{% if date_to %}&date_to={{date_to}}{% endif %}">Last &raquo;</a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">Next</span>
            </li>
            <li class="page-item disabled">
              <span class="page-link">Last &raquo;</span>
            </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}

{% else %}
<div class="alert alert-info text-center" role="alert">
  <i class="fas fa-info-circle"></i> No videos found
  {% if search_query or status_filter or patient_filter or date_from or date_to %}
    matching your search criteria. <a href="{% url 'video:manager' %}" class="alert-link">Clear filters</a>
  {% endif %}
</div>

{% endif %}

</div>

{% endblock main_content %}
