{% extends 'src/base.html' %}
{% load static %}
{% block title %}{{ page_title|default:"Video Manager" }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/manager.css' %}">
{% endblock extra_css %}

{% block main_content %}
<!-- Main content wrapper -->
<div class="container-fluid">
  
  <!-- Search and Filter Section -->
  <div class="card mb-4">
    <div class="card-header bg-info">
      <div class="d-flex justify-content-between align-items-center">
        <h3 class="card-title mb-0">
          <i class="fas fa-video"></i> 
          {% if patient %}
            Videos for {{ patient.baby_name }}
          {% else %}
            Video Manager
          {% endif %}
          {% if total_count %}
            <span class="badge badge-light ml-2">{{ total_count }} video{{ total_count|pluralize }}</span>
          {% endif %}
        </h3>
        <!-- Quick Actions Dropdown -->
        <div class="btn-group" role="group">
          <i style="cursor: pointer;" class="fas fa-cog dropdown-toggle" id="btnGroupDrop1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></i>
          <div class="dropdown-menu dropdown-menu-right" aria-labelledby="btnGroupDrop1">
            <a class="dropdown-item" href="{% url 'video:manager' %}"><i class="fas fa-video"></i> All Videos</a>
            <a class="dropdown-item" href="{% url 'video:manager-new-only' %}"><i class="fas fa-plus-circle"></i> New Videos Only</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="{% url 'add-patient' %}"><i class="fas fa-user-plus"></i> Add New Patient</a>
            {% if patient %}
              <a class="dropdown-item" href="{% url 'video:add' patient.id %}"><i class="fas fa-upload"></i> Upload Video</a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    <div class="card-body">
      <form method="get" class="row">
        <div class="col-md-3 mb-2">
          <input type="text" name="search" class="form-control" placeholder="Search videos..." value="{{search_query}}">
        </div>
        <div class="col-md-2 mb-2">
          <select name="status" class="form-control">
            <option value="">All Statuses</option>
            {% for status_value, status_label in status_choices %}
              <option value="{{status_value}}" {% if status_filter == status_value %}selected{% endif %}>{{status_label}}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2 mb-2">
          <select name="patient" class="form-control">
            <option value="">All Patients</option>
            {% for p in patients %}
              <option value="{{p.id}}" {% if patient_filter == p.id|stringformat:"s" %}selected{% endif %}>{{p.baby_name}}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2 mb-2">
          <input type="date" name="date_from" class="form-control" placeholder="From Date" value="{{date_from}}">
        </div>
        <div class="col-md-2 mb-2">
          <input type="date" name="date_to" class="form-control" placeholder="To Date" value="{{date_to}}">
        </div>
        <div class="col-md-1 mb-2">
          <button type="submit" class="btn btn-primary btn-block">
            <i class="fas fa-search"></i>
          </button>
        </div>
      </form>
    </div>
  </div>

  {% if file_list %}

  <!-- Patient Identification Details (if viewing patient-specific videos) -->
    {% if patient %}
    <div class="card mb-3 patient-id-card shadow-sm border-0 w-100" style="margin: 0 auto;">
      <div class="card-body py-3 px-4">
        <div class="row align-items-center">
          <div class="col-auto pr-0">
            <i class="fas fa-user-circle fa-2x text-primary"></i>
          </div>
          <div class="col">
            <h5 class="mb-1 font-weight-bold">{{ patient.baby_name }}</h5>
            <div class="small text-muted">DOB: {{ patient.dob|date:'M d, Y' }} | Gender: {{ patient.get_gender_display }}</div>
          </div>
          <div class="col-auto text-right">
            <span class="badge badge-dark px-3 py-2" style="font-size: 1rem;">Disk No: {{ patient.disk_no|default:'N/A' }}</span>
          </div>
        </div>
        <div class="row mt-2">
          <div class="col">
            <div class="d-flex flex-wrap gap-2">
              {% if patient.bht_no %}<span class="badge badge-primary">BHT: {{ patient.bht_no }}</span>{% endif %}
              {% if patient.nnc_no %}<span class="badge badge-success">NNC: {{ patient.nnc_no }}</span>{% endif %}
              {% if patient.pin %}<span class="badge badge-warning">PIN: {{ patient.pin }}</span>{% endif %}
              {% if patient.ptc_no %}<span class="badge badge-info">PTC: {{ patient.ptc_no }}</span>{% endif %}
              {% if patient.pc_no %}<span class="badge badge-secondary">PC: {{ patient.pc_no }}</span>{% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

  <!-- Video List Card -->
  <div class="card">
    <div class="card-header bg-secondary">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
          <i class="fas fa-list"></i> Video List
        </h5>
        <small class="text-muted">
          Page {{ file_list.number }} of {{ file_list.paginator.num_pages }}
          ({{ file_list.start_index }} - {{ file_list.end_index }} of {{ total_count }})
        </small>
      </div>
    </div>

    <!-- Responsive Table Wrapper -->
    <div class="table-responsive">
      <table class="table table-hover text-nowrap">
        <thead class="thead-dark">
    <tr>
      <th scope="col" style="width: 5%">ID</th>
      <th scope="col" style="width: 10%">Status</th>
      <th scope="col" style="width: 15%">Patient</th>
      <th scope="col" style="width: 15%">Title</th>
      <th scope="col" style="width: 10%">Duration</th>
      <th scope="col" style="width: 10%">Size</th>
      <th scope="col" style="width: 10%">Recorded</th>
      <th scope="col" style="width: 10%">Uploaded</th>
      <th scope="col" style="width: 10%">By</th>
      <th scope="col" style="width: 5%">Action</th>
    </tr>
  </thead>
  <tbody>
    {% for video in file_list %}
    <tr>
      <th scope="row">{{ video.id }}</th>
      
      <td>
        <div class="d-flex align-items-center">
          <!-- Processing Status Badge -->
          {% if video.processing_status == 'completed' %}
            <span class="badge badge-success" data-toggle="tooltip" title="Processing Complete">
              <i class="fas fa-check"></i> Ready
            </span>
          {% elif video.processing_status == 'processing' %}
            <span class="badge badge-warning" data-toggle="tooltip" title="Processing">
              <i class="fas fa-spinner fa-spin"></i> Processing
            </span>
          {% elif video.processing_status == 'failed' %}
            <span class="badge badge-danger" data-toggle="tooltip" title="Processing Failed">
              <i class="fas fa-times"></i> Failed
            </span>
          {% else %}
            <span class="badge badge-secondary" data-toggle="tooltip" title="Pending Processing">
              <i class="fas fa-clock"></i> Pending
            </span>
          {% endif %}
          
          <!-- Assessment Status -->
          <div class="ml-2">
            {% if video.is_new_file %}
              <span class="badge badge-danger" data-toggle="tooltip" title="New - Not used in assessment">New</span>
            {% else %}
              <i class="fas fa-check-circle text-success" data-toggle="tooltip" title="Used in assessment"></i>
            {% endif %}
          </div>
          
          <!-- Bookmark Status -->
          {% if video.is_bookmarked %}
            <div class="ml-2">
              <a href="{% url 'bookmark-view' video.get_bookmark.id %}" class="text-primary" data-toggle="tooltip" title="Bookmarked">
                <i class="fas fa-bookmark"></i>
              </a>
            </div>
          {% endif %}
        </div>
      </td>
      
      <td>
        <strong>{{video.patient.baby_name}}</strong><br>
        <small class="text-muted">{{video.patient.file_no|default:"No file #"}}</small>
      </td>
      
      <td>
        <div data-toggle="tooltip" title="{{video.description|default:'No description'}}">
          {{video.title|truncatechars:30}}
        </div>
        {% if video.description %}
          <small class="text-muted">{{video.description|truncatechars:50}}</small>
        {% endif %}
      </td>

      <td>
        <i class="fas fa-play-circle text-danger" data-toggle="tooltip" title="Video File"></i>
        <span class="ml-1">{{video.duration_formatted}}</span>
        {% if video.resolution != "Unknown" %}
          <br><small class="text-muted">{{video.resolution}}</small>
        {% endif %}
      </td>

      <td>
        <span>{{video.file_size_mb}} MB</span>
        {% if video.file_extension %}
          <br><small class="text-muted">{{video.file_extension|upper}}</small>
        {% endif %}
      </td>

      <td>
        {{video.recorded_on|date:"M d, Y"}}
        <br><small class="text-muted">{{video.recorded_on|date:"H:i"}}</small>
        {% if video.age_on_recording %}
          <br><small class="text-info">{{video.age_on_recording}}</small>
        {% endif %}
      </td>
      
      <td>
        {{video.created_at|date:"M d, Y"}}
        <br><small class="text-muted">{{video.created_at|date:"H:i"}}</small>
      </td>
      
      <td>
        {{video.added_by.get_full_name|default:video.added_by.username}}
        {% if video.updated_by and video.updated_by != video.added_by %}
          <br><small class="text-muted">Modified by: {{video.updated_by.username}}</small>
        {% endif %}
      </td>
      
      <td>
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-ellipsis-v"></i>
          </button>
          <div class="dropdown-menu dropdown-menu-right">
            <a class="dropdown-item" href="{% url 'video:view' video.id %}">
              <i class="fas fa-eye text-primary"></i> View/Play
            </a>
            <a class="dropdown-item" href="{% url 'video:edit' video.id %}">
              <i class="fas fa-edit text-warning"></i> Edit Details
            </a>
            <a class="dropdown-item" href="{% url 'video:delete-confirm' video.id %}">
              <i class="fas fa-trash-alt text-danger"></i> Delete
            </a>
            <div class="dropdown-divider"></div>
            {% if video.is_new_file %}
              <a class="dropdown-item" href="{% url 'assessment-add' video.patient.id video.id %}">
                <i class="fas fa-plus-circle text-success"></i> New Assessment
              </a>
            {% else %}
              <a class="dropdown-item" href="{% url 'assessment-view-by-file-id' video.id %}">
                <i class="fas fa-eye text-info"></i> View Assessment
              </a>
            {% endif %}
            <a class="dropdown-item" href="{% url 'view-patient' video.patient.id %}">
              <i class="fas fa-user text-info"></i> View Patient
            </a>
          </div>
        </div>
      </td>
    </tr>
    {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pagination Section -->
  {% if file_list.paginator.num_pages > 1 %}
  <nav aria-label="Video pagination" class="mt-4">
    <ul class="pagination justify-content-center">
          {% if file_list.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page=1{% if search_query %}&search={{search_query}}{% endif %}{% if status_filter %}&status={{status_filter}}{% endif %}{% if patient_filter %}&patient={{patient_filter}}{% endif %}{% if date_from %}&date_from={{date_from}}{% endif %}{% if date_to %}&date_to={{date_to}}{% endif %}">&laquo; First</a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ file_list.previous_page_number }}{% if search_query %}&search={{search_query}}{% endif %}{% if status_filter %}&status={{status_filter}}{% endif %}{% if patient_filter %}&patient={{patient_filter}}{% endif %}{% if date_from %}&date_from={{date_from}}{% endif %}{% if date_to %}&date_to={{date_to}}{% endif %}">Previous</a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">&laquo; First</span>
            </li>
            <li class="page-item disabled">
              <span class="page-link">Previous</span>
            </li>
          {% endif %}
          
          <li class="page-item active">
            <span class="page-link">
              Page {{ file_list.number }} of {{ file_list.paginator.num_pages }}
            </span>
          </li>
          
          {% if file_list.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ file_list.next_page_number }}{% if search_query %}&search={{search_query}}{% endif %}{% if status_filter %}&status={{status_filter}}{% endif %}{% if patient_filter %}&patient={{patient_filter}}{% endif %}{% if date_from %}&date_from={{date_from}}{% endif %}{% if date_to %}&date_to={{date_to}}{% endif %}">Next</a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ file_list.paginator.num_pages }}{% if search_query %}&search={{search_query}}{% endif %}{% if status_filter %}&status={{status_filter}}{% endif %}{% if patient_filter %}&patient={{patient_filter}}{% endif %}{% if date_from %}&date_from={{date_from}}{% endif %}{% if date_to %}&date_to={{date_to}}{% endif %}">Last &raquo;</a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">Next</span>
            </li>
            <li class="page-item disabled">
              <span class="page-link">Last &raquo;</span>
            </li>
          {% endif %}
    </ul>
  </nav>
  {% endif %}

  {% else %}
  <!-- No Videos Found -->
  <div class="card">
    <div class="card-body text-center py-5">
      <div class="alert alert-info" role="alert">
        <i class="fas fa-info-circle fa-2x mb-3"></i>
        <h5>No videos found</h5>
        <p class="mb-0">
          {% if search_query or status_filter or patient_filter or date_from or date_to %}
            No videos match your search criteria.
            <br>
            <a href="{% if patient %}{% url 'video:manager-by-patient' patient.id %}{% else %}{% url 'video:manager' %}{% endif %}" class="btn btn-outline-info btn-sm mt-2">
              <i class="fas fa-times"></i> Clear filters
            </a>
          {% else %}
            {% if patient %}
              This patient has no videos yet.
              <br>
              <a href="{% url 'video:add' patient.id %}" class="btn btn-primary btn-sm mt-2">
                <i class="fas fa-upload"></i> Upload First Video
              </a>
            {% else %}
              No videos have been uploaded to the system yet.
              <br>
              <a href="{% url 'add-patient' %}" class="btn btn-primary btn-sm mt-2">
                <i class="fas fa-user-plus"></i> Add Patient & Upload Video
              </a>
            {% endif %}
          {% endif %}
        </p>
      </div>
    </div>
  </div>
  {% endif %}

</div>

{% block extra_js %}
<script src="{% static 'js/manager.js' %}"></script>
<script>
// Initialize tooltips
$(function () {
  $('[data-toggle="tooltip"]').tooltip();
});

// Auto-submit search form on Enter key
$('form input[name="search"]').on('keypress', function(e) {
  if (e.which === 13) {
    $(this).closest('form').submit();
  }
});

// Auto-submit form when filters change
$('form select').on('change', function() {
  $(this).closest('form').submit();
});
</script>
{% endblock extra_js %}

{% endblock main_content %}
