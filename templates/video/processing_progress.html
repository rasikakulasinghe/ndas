{% extends 'src/base.html' %}
{% load static %}
{% block title %}Processing Video - {{ patient.baby_name }}{% endblock %}

{% block content_header %}
<div class="row mb-2">
  <div class="col-sm-6">
    <h1 class="m-0">Video Processing</h1>
  </div>
  <div class="col-sm-6">
    <ol class="breadcrumb float-sm-right">
      <li class="breadcrumb-item"><a href="{% url 'home' %}">Dashboard</a></li>
      <li class="breadcrumb-item"><a href="{% url 'view-patient' patient.id %}">{{ patient.baby_name }}</a></li>
      <li class="breadcrumb-item active">Processing Video</li>
    </ol>
  </div>
</div>
{% endblock content_header %}

{% block main_content %}
<div class="video-processing-container">
  <!-- Patient Information Card -->
  <div class="row">
    <div class="col-md-6">
      <div class="card card-primary">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-user-md mr-2"></i>Patient Information
          </h3>
        </div>
        <div class="card-body">
          <div class="row mb-2">
            <div class="col-4"><strong>BHT:</strong></div>
            <div class="col-8">{{ patient.bht }}</div>
          </div>
          <div class="row mb-2">
            <div class="col-4"><strong>Baby Name:</strong></div>
            <div class="col-8">{{ patient.baby_name }}</div>
          </div>
          <div class="row mb-2">
            <div class="col-4"><strong>Mother Name:</strong></div>
            <div class="col-8">{{ patient.mother_name }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Video Information -->
    <div class="col-md-6">
      <div class="card card-info">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-video mr-2"></i>Video Information
          </h3>
        </div>
        <div class="card-body">
          <div class="row mb-2">
            <div class="col-4"><strong>Title:</strong></div>
            <div class="col-8">{{ video.title }}</div>
          </div>
          <div class="row mb-2">
            <div class="col-4"><strong>File Size:</strong></div>
            <div class="col-8" id="file-size">
              {% if video.file_size %}
                {{ video.file_size|filesizeformat }}
              {% else %}
                Calculating...
              {% endif %}
            </div>
          </div>
          <div class="row mb-2">
            <div class="col-4"><strong>Duration:</strong></div>
            <div class="col-8" id="video-duration">
              {% if video.duration_seconds %}
                {{ video.duration_seconds|floatformat:1 }}s
              {% else %}
                Analyzing...
              {% endif %}
            </div>
          </div>
          <div class="row mb-2">
            <div class="col-4"><strong>Resolution:</strong></div>
            <div class="col-8" id="video-resolution">
              {% if video.original_resolution %}
                {{ video.original_resolution }}
              {% else %}
                Detecting...
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Processing Status Card -->
  <div class="row mt-4">
    <div class="col-md-12">
      <div class="card card-warning" id="processing-card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-cogs mr-2"></i>Processing Status
          </h3>
        </div>
        <div class="card-body">
          <!-- Progress Bar -->
          <div class="progress mb-4" style="height: 25px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" 
                 id="progress-bar" 
                 role="progressbar" 
                 style="width: 0%;" 
                 aria-valuenow="0" 
                 aria-valuemin="0" 
                 aria-valuemax="100">
              <span id="progress-text">0%</span>
            </div>
          </div>

          <!-- Status Information -->
          <div class="row">
            <div class="col-md-8">
              <h5 id="status-title">
                <i class="fas fa-spinner fa-spin mr-2"></i>
                <span id="status-message">Initializing processing...</span>
              </h5>
              <p id="status-description" class="text-muted">
                Please wait while we process your video for optimal playback.
              </p>
            </div>
            <div class="col-md-4 text-right">
              <div id="processing-stats" style="display: none;">
                <small class="text-muted">
                  <div>Started: <span id="start-time">--</span></div>
                  <div>Task ID: <span id="task-id">{{ task_id|default:"--" }}</span></div>
                </small>
              </div>
            </div>
          </div>

          <!-- Processing Steps -->
          <div class="processing-steps mt-4">
            <div class="row">
              <div class="col-md-3">
                <div class="step-item" id="step-metadata">
                  <i class="fas fa-info-circle step-icon"></i>
                  <div class="step-title">Extracting Metadata</div>
                  <div class="step-status">Pending</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="step-item" id="step-thumbnails">
                  <i class="fas fa-image step-icon"></i>
                  <div class="step-title">Generating Thumbnails</div>
                  <div class="step-status">Pending</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="step-item" id="step-compression">
                  <i class="fas fa-compress-arrows-alt step-icon"></i>
                  <div class="step-title">Optimizing Video</div>
                  <div class="step-status">Pending</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="step-item" id="step-finalization">
                  <i class="fas fa-check-circle step-icon"></i>
                  <div class="step-title">Finalizing</div>
                  <div class="step-status">Pending</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Completion Card (hidden initially) -->
  <div class="row mt-4" id="completion-card" style="display: none;">
    <div class="col-md-12">
      <div class="card card-success">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-check-circle mr-2"></i>Processing Complete
          </h3>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-8">
              <h5><i class="fas fa-thumbs-up mr-2"></i>Your video has been processed successfully!</h5>
              <p class="text-muted">The video is now ready for viewing and has been optimized for web playback.</p>
              
              <div id="compression-stats" class="mt-3" style="display: none;">
                <h6>Compression Results:</h6>
                <ul class="list-unstyled">
                  <li><i class="fas fa-compress mr-1"></i> <strong>Compression Ratio:</strong> <span id="compression-ratio">--</span></li>
                  <li><i class="fas fa-save mr-1"></i> <strong>Space Saved:</strong> <span id="space-saved">--</span></li>
                  <li><i class="fas fa-clock mr-1"></i> <strong>Processing Time:</strong> <span id="processing-time">--</span></li>
                </ul>
              </div>
            </div>
            <div class="col-md-4 text-right">
              <div class="btn-group-vertical" role="group">
                <button type="button" class="btn btn-primary btn-lg mb-2" id="btn-view-video">
                  <i class="fas fa-play mr-2"></i>View Video
                </button>
                <button type="button" class="btn btn-secondary mb-2" id="btn-edit-details">
                  <i class="fas fa-edit mr-2"></i>Edit Details
                </button>
                <button type="button" class="btn btn-info" onclick="window.location.href='{% url 'view-patient' patient.id %}'">
                  <i class="fas fa-arrow-left mr-2"></i>Back to Patient
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Card (hidden initially) -->
  <div class="row mt-4" id="error-card" style="display: none;">
    <div class="col-md-12">
      <div class="card card-danger">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-exclamation-triangle mr-2"></i>Processing Failed
          </h3>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-8">
              <h5><i class="fas fa-times-circle mr-2"></i>Video processing encountered an error</h5>
              <p id="error-message" class="text-muted">An unexpected error occurred during processing.</p>
            </div>
            <div class="col-md-4 text-right">
              <div class="btn-group-vertical" role="group">
                <button type="button" class="btn btn-warning btn-lg mb-2" id="btn-retry-processing">
                  <i class="fas fa-redo mr-2"></i>Retry Processing
                </button>
                <button type="button" class="btn btn-info" onclick="window.location.href='{% url 'view-patient' patient.id %}'">
                  <i class="fas fa-arrow-left mr-2"></i>Back to Patient
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.step-item {
  text-align: center;
  padding: 10px;
  border-radius: 8px;
  background: #f8f9fa;
  margin-bottom: 10px;
  transition: all 0.3s ease;
}

.step-item.active {
  background: #fff3cd;
  border: 2px solid #ffc107;
}

.step-item.completed {
  background: #d4edda;
  border: 2px solid #28a745;
}

.step-item.failed {
  background: #f8d7da;
  border: 2px solid #dc3545;
}

.step-icon {
  font-size: 24px;
  margin-bottom: 8px;
  display: block;
  color: #6c757d;
}

.step-item.active .step-icon {
  color: #ffc107;
}

.step-item.completed .step-icon {
  color: #28a745;
}

.step-item.failed .step-icon {
  color: #dc3545;
}

.step-title {
  font-weight: bold;
  font-size: 14px;
  margin-bottom: 4px;
}

.step-status {
  font-size: 12px;
  color: #6c757d;
}

.step-item.active .step-status {
  color: #ffc107;
  font-weight: bold;
}

.step-item.completed .step-status {
  color: #28a745;
  font-weight: bold;
}

.step-item.failed .step-status {
  color: #dc3545;
  font-weight: bold;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const videoId = {{ video.id }};
    let pollInterval;
    let startTime = Date.now();
    
    // Initialize processing stats display
    document.getElementById('processing-stats').style.display = 'block';
    document.getElementById('start-time').textContent = new Date().toLocaleTimeString();
    
    // Start polling for status updates
    startStatusPolling();
    
    function startStatusPolling() {
        pollInterval = setInterval(checkProcessingStatus, 2000); // Poll every 2 seconds
        checkProcessingStatus(); // Initial check
    }
    
    function stopStatusPolling() {
        if (pollInterval) {
            clearInterval(pollInterval);
        }
    }
    
    function checkProcessingStatus() {
        fetch(`/api/videos/${videoId}/status/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            updateProgressUI(data);
            
            if (data.is_complete || data.is_failed) {
                stopStatusPolling();
                if (data.is_complete) {
                    showCompletionCard(data);
                } else {
                    showErrorCard(data);
                }
            }
        })
        .catch(error => {
            console.error('Error checking processing status:', error);
        });
    }
    
    function updateProgressUI(data) {
        // Update progress bar
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        
        progressBar.style.width = data.progress + '%';
        progressBar.setAttribute('aria-valuenow', data.progress);
        progressText.textContent = data.progress + '%';
        
        // Update status message
        const statusMessage = document.getElementById('status-message');
        const statusDescription = document.getElementById('status-description');
        
        const statusMessages = {
            'pending': 'Initializing processing...',
            'extracting_metadata': 'Analyzing video properties...',
            'generating_thumbnails': 'Creating video thumbnails...',
            'compressing': 'Optimizing video for web playback...',
            'finalizing': 'Finalizing processed video...',
            'processing': 'Processing video...'
        };
        
        statusMessage.textContent = statusMessages[data.status] || 'Processing...';
        
        // Update step indicators
        updateStepIndicators(data.status);
        
        // Update metadata if available
        if (data.metadata) {
            if (data.metadata.duration) {
                document.getElementById('video-duration').textContent = data.metadata.duration.toFixed(1) + 's';
            }
            if (data.metadata.resolution) {
                document.getElementById('video-resolution').textContent = data.metadata.resolution;
            }
        }
    }
    
    function updateStepIndicators(status) {
        const steps = {
            'extracting_metadata': 'step-metadata',
            'generating_thumbnails': 'step-thumbnails', 
            'compressing': 'step-compression',
            'finalizing': 'step-finalization'
        };
        
        // Reset all steps
        Object.values(steps).forEach(stepId => {
            const step = document.getElementById(stepId);
            step.classList.remove('active', 'completed', 'failed');
            step.querySelector('.step-status').textContent = 'Pending';
        });
        
        // Mark completed steps
        const stepOrder = ['extracting_metadata', 'generating_thumbnails', 'compressing', 'finalizing'];
        const currentIndex = stepOrder.indexOf(status);
        
        stepOrder.forEach((step, index) => {
            const stepElement = document.getElementById(steps[step]);
            if (index < currentIndex) {
                stepElement.classList.add('completed');
                stepElement.querySelector('.step-status').textContent = 'Completed';
            } else if (index === currentIndex) {
                stepElement.classList.add('active');
                stepElement.querySelector('.step-status').textContent = 'In Progress';
            }
        });
    }
    
    function showCompletionCard(data) {
        document.getElementById('processing-card').style.display = 'none';
        document.getElementById('completion-card').style.display = 'block';
        
        // Setup buttons
        document.getElementById('btn-view-video').onclick = () => {
            window.location.href = data.redirect_url || `/videos/${videoId}/`;
        };
        
        document.getElementById('btn-edit-details').onclick = () => {
            window.location.href = `/videos/${videoId}/edit/`;
        };
        
        // Show processing time
        const processingTime = Math.round((Date.now() - startTime) / 1000);
        document.getElementById('processing-time').textContent = formatDuration(processingTime);
        
        // Show compression stats if available
        if (data.compression_ratio || data.space_saved) {
            document.getElementById('compression-stats').style.display = 'block';
            if (data.compression_ratio) {
                document.getElementById('compression-ratio').textContent = data.compression_ratio + '%';
            }
            if (data.space_saved) {
                document.getElementById('space-saved').textContent = data.space_saved + ' MB';
            }
        }
    }
    
    function showErrorCard(data) {
        document.getElementById('processing-card').style.display = 'none';
        document.getElementById('error-card').style.display = 'block';
        
        if (data.error_message) {
            document.getElementById('error-message').textContent = data.error_message;
        }
        
        // Setup retry button
        document.getElementById('btn-retry-processing').onclick = () => {
            retryProcessing();
        };
    }
    
    function retryProcessing() {
        fetch(`/api/videos/${videoId}/process/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reset UI and restart polling
                document.getElementById('error-card').style.display = 'none';
                document.getElementById('processing-card').style.display = 'block';
                startTime = Date.now();
                startStatusPolling();
            } else {
                alert('Failed to restart processing: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error retrying processing:', error);
            alert('Failed to restart processing. Please try again.');
        });
    }
    
    function formatDuration(seconds) {
        if (seconds < 60) {
            return seconds + 's';
        } else if (seconds < 3600) {
            return Math.floor(seconds / 60) + 'm ' + (seconds % 60) + 's';
        } else {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return hours + 'h ' + minutes + 'm';
        }
    }
});
</script>

{% endblock main_content %}
