{% extends 'src/base.html' %}
{% load static %}
{% block title %}Developmental Assessment Manager{% endblock title %}

{% block main_content %}
<div class="container-fluid">
  <div class="content-header">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0">
            <i class="fas fa-child text-primary mr-2"></i>Developmental Assessment Manager
            {% if patient %}
              <small class="text-muted"> :: {{ patient.baby_name }}</small>
            {% endif %}
          </h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
            {% if patient %}
              <li class="breadcrumb-item"><a href="{% url 'da-assessment-manager' %}">Dev. Assessments</a></li>
              <li class="breadcrumb-item active">{{ patient.baby_name }}</li>
            {% else %}
              <li class="breadcrumb-item active">Dev. Assessments</li>
            {% endif %}
          </ol>
        </div>
      </div>
  </div>

  <section class="content">

      <!-- Statistics Cards -->
      <div class="row mb-4">
        <div class="col-lg-3 col-6">
          <div class="small-box bg-info">
            <div class="inner">
              <h3>{{ da_stats.total|default:0 }}</h3>
              <p>Total Assessments</p>
            </div>
            <div class="icon">
              <i class="fas fa-child"></i>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-6">
          <div class="small-box bg-success">
            <div class="inner">
              <h3>{{ da_stats.normal|default:0 }}</h3>
              <p>Normal Development</p>
            </div>
            <div class="icon">
              <i class="fas fa-check-circle"></i>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-6">
          <div class="small-box bg-warning">
            <div class="inner">
              <h3>{{ da_stats.delayed|default:0 }}</h3>
              <p>Developmental Delays</p>
            </div>
            <div class="icon">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-6">
          <div class="small-box bg-secondary">
            <div class="inner">
              <h3>{{ da_stats.this_month|default:0 }}</h3>
              <p>This Month</p>
            </div>
            <div class="icon">
              <i class="fas fa-calendar"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Search and Filter Section -->
      <div class="card card-secondary collapsed-card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-search mr-2"></i>Search & Filter Options
          </h3>
          <div class="card-tools">
            <button type="button" class="btn btn-tool" data-card-widget="collapse">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>
        <div class="card-body" style="display: none;">
          <form method="GET" id="searchForm">
            <div class="row">
              <div class="col-md-3">
                <div class="form-group">
                  <label for="search_patient">Search Patient</label>
                  <input type="text" class="form-control" id="search_patient" name="search_patient" 
                         value="{{ request.GET.search_patient }}" placeholder="Enter patient name...">
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label for="development_status">Development Status</label>
                  <select class="form-control" id="development_status" name="development_status">
                    <option value="">All Statuses</option>
                    <option value="normal" {% if request.GET.development_status == 'normal' %}selected{% endif %}>Normal Development</option>
                    <option value="delayed" {% if request.GET.development_status == 'delayed' %}selected{% endif %}>Developmental Delay</option>
                  </select>
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label for="age_range">Age Range (months)</label>
                  <select class="form-control" id="age_range" name="age_range">
                    <option value="">All Ages</option>
                    <option value="0-6" {% if request.GET.age_range == '0-6' %}selected{% endif %}>0-6 months</option>
                    <option value="6-12" {% if request.GET.age_range == '6-12' %}selected{% endif %}>6-12 months</option>
                    <option value="12-24" {% if request.GET.age_range == '12-24' %}selected{% endif %}>12-24 months</option>
                    <option value="24-36" {% if request.GET.age_range == '24-36' %}selected{% endif %}>24-36 months</option>
                    <option value="36-48" {% if request.GET.age_range == '36-48' %}selected{% endif %}>36-48 months</option>
                    <option value="48-72" {% if request.GET.age_range == '48-72' %}selected{% endif %}>48-72 months</option>
                  </select>
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label for="date_range">Assessment Date Range</label>
                  <select class="form-control" id="date_range" name="date_range">
                    <option value="">All Time</option>
                    <option value="today" {% if request.GET.date_range == 'today' %}selected{% endif %}>Today</option>
                    <option value="week" {% if request.GET.date_range == 'week' %}selected{% endif %}>This Week</option>
                    <option value="month" {% if request.GET.date_range == 'month' %}selected{% endif %}>This Month</option>
                    <option value="quarter" {% if request.GET.date_range == 'quarter' %}selected{% endif %}>This Quarter</option>
                    <option value="year" {% if request.GET.date_range == 'year' %}selected{% endif %}>This Year</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="assessor">Assessed By</label>
                  <input type="text" class="form-control" id="assessor" name="assessor" 
                         value="{{ request.GET.assessor }}" placeholder="Enter assessor name...">
                </div>
              </div>
              <div class="col-md-6 d-flex align-items-end">
                <div class="form-group w-100">
                  <button type="submit" class="btn btn-primary mr-2">
                    <i class="fas fa-search mr-1"></i>Search
                  </button>
                  <a href="{% url 'da-assessment-manager' %}{% if patient %}{{ patient.id }}{% endif %}" class="btn btn-secondary">
                    <i class="fas fa-times mr-1"></i>Clear Filters
                  </a>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Results Section -->
      {% if da_record_list %}
        <div class="card">
          <div class="card-header bg-primary">
            <h3 class="card-title">
              <i class="fas fa-list mr-2"></i>Developmental Assessment Records
              <span class="badge badge-light ml-2">{{ da_record_list|length }} records</span>
            </h3>
            <div class="card-tools">
              <div class="input-group input-group-sm" style="width: 250px;">
                <input type="text" id="quickSearch" class="form-control float-right" placeholder="Quick search...">
                <div class="input-group-append">
                  <button type="submit" class="btn btn-default">
                    <i class="fas fa-search"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="card-body table-responsive p-0">
            <table class="table table-hover text-nowrap" id="daTable">
              <thead>
                <tr>
                  <th><i class="fas fa-hashtag mr-1"></i>ID</th>
                  <th><i class="fas fa-heart-rate mr-1"></i>Status</th>
                  <th><i class="fas fa-user mr-1"></i>Patient Name</th>
                  <th><i class="fas fa-calendar-alt mr-1"></i>Assessment Date</th>
                  <th><i class="fas fa-birthday-cake mr-1"></i>Age at Assessment</th>
                  <th><i class="fas fa-user-md mr-1"></i>Assessed By</th>
                  <th><i class="fas fa-user-plus mr-1"></i>Created By</th>
                  <th><i class="fas fa-cogs mr-1"></i>Actions</th>
                </tr>
              </thead>
              <tbody>

                {% for DARecord in da_record_list %}
                <tr data-da-id="{{ DARecord.id }}">
                  <td>
                    <div class="d-flex align-items-center">
                      <span class="badge badge-secondary mr-2">{{ DARecord.id }}</span>
                      {% if DARecord.isBookmarked %}
                        <a href="{% url 'bookmark-view' DARecord.isBookmarked.id %}" 
                           data-toggle="tooltip" data-placement="top" title="Bookmarked" 
                           class="text-primary">
                          <i class="fas fa-bookmark"></i>
                        </a>
                      {% endif %}
                    </div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      {% if DARecord.is_dx_normal %}
                        <span class="badge badge-success mr-2">
                          <i class="fas fa-check-circle mr-1"></i>Normal
                        </span>
                        <span class="text-success">Typical Development</span>
                      {% else %}
                        <span class="badge badge-warning mr-2">
                          <i class="fas fa-exclamation-triangle mr-1"></i>Delay
                        </span>
                        <span class="text-warning">Developmental Concern</span>
                      {% endif %}
                    </div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="user-panel-info">
                        <a href="{% url 'view-patient' DARecord.patient.id %}" class="text-decoration-none">
                          <strong>{{ DARecord.patient.baby_name }}</strong>
                        </a>
                        {% if DARecord.patient.getCurrentAge %}
                          <br><small class="text-muted">Current: {{ DARecord.patient.getCurrentAge }}</small>
                        {% endif %}
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="assessment-date">
                      <i class="fas fa-calendar text-info mr-1"></i>
                      <strong>{{ DARecord.date_of_assessment|date:"M d, Y" }}</strong>
                      <br><small class="text-muted">{{ DARecord.date_of_assessment|timesince }} ago</small>
                    </div>
                  </td>
                  <td>
                    <div class="age-info">
                      <span class="badge badge-info">{{ DARecord.getAssessmentAgeInMonths }}</span>
                      <br><small class="text-muted">
                        {% with months=DARecord.getAssessmentAgeInMonths %}
                          {% if months < 12 %}
                            {{ months }} month{{ months|pluralize }}
                          {% else %}
                            {% widthratio months 12 1 %} year{{ months|pluralize }}
                          {% endif %}
                        {% endwith %}
                      </small>
                    </div>
                  </td>
                  <td>
                    <div class="assessor-info">
                      <i class="fas fa-user-md text-primary mr-1"></i>
                      <strong>{{ DARecord.assessment_done_by }}</strong>
                    </div>
                  </td>
                  <td>
                    <div data-toggle="tooltip" data-placement="top" 
                         title="Created: {{ DARecord.added_on|date:'F d, Y g:i A' }}{% if DARecord.last_edit_by %} | Last edited: {{ DARecord.last_edit_on|date:'F d, Y g:i A' }} by {{ DARecord.last_edit_by.username }}{% endif %}">
                      <a href="{% url 'user-view-by-username' DARecord.added_by.username %}" class="text-decoration-none">
                        <i class="fas fa-user text-primary mr-1"></i>{{ DARecord.added_by.username }}
                      </a>
                      <br><small class="text-muted">{{ DARecord.added_on|timesince }} ago</small>
                    </div>
                  </td>
                  <td>
                    <div class="btn-group" role="group">
                      <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                              data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-cogs"></i> Actions
                      </button>
                      <div class="dropdown-menu dropdown-menu-right">
                        <!-- Primary Actions -->
                        <a class="dropdown-item" href="{% url 'da-assessment-view' DARecord.id %}">
                          <i class="fas fa-eye text-info mr-2"></i>View Assessment
                        </a>
                        <a class="dropdown-item" href="{% url 'da-assessment-edit' DARecord.id %}">
                          <i class="fas fa-edit text-warning mr-2"></i>Edit Assessment
                        </a>
                        <div class="dropdown-divider"></div>
                        
                        <!-- Related Records -->
                        <a class="dropdown-item" href="{% url 'view-patient' DARecord.patient.id %}">
                          <i class="fas fa-user text-primary mr-2"></i>View Patient
                        </a>
                        <a class="dropdown-item" href="{% url 'da-assessment-manager-patient' DARecord.patient.id %}">
                          <i class="fas fa-list text-secondary mr-2"></i>All Patient Assessments
                        </a>
                        <div class="dropdown-divider"></div>
                        
                        <!-- Bookmark Actions -->
                        {% if DARecord.isBookmarked %}
                          <a class="dropdown-item" href="{% url 'bookmark-view' DARecord.isBookmarked.id %}">
                            <i class="fas fa-bookmark text-primary mr-2"></i>View Bookmark
                          </a>
                        {% else %}
                          <a class="dropdown-item" href="{% url 'bookmark-add' DARecord.id 'DA' %}">
                            <i class="fas fa-plus text-success mr-2"></i>Add Bookmark
                          </a>
                        {% endif %}
                        
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item text-danger" href="{% url 'da-assessment-delete_start' DARecord.id %}" 
                           onclick="return confirm('Are you sure you want to delete this developmental assessment?')">
                          <i class="fas fa-trash-alt mr-2"></i>Delete Assessment
                        </a>
                      </div>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          <!-- Pagination -->
          {% if da_record_list and da_record_list.paginator.num_pages > 1 %}
            <div class="card-footer">
              <div class="row align-items-center">
                <div class="col-sm-6">
                  <div class="dataTables_info">
                    Showing {{ da_record_list.start_index }} to {{ da_record_list.end_index }} 
                    of {{ da_record_list.paginator.count }} entries
                  </div>
                </div>
                <div class="col-sm-6">
                  <nav aria-label="Developmental assessment pagination">
                    <ul class="pagination pagination-sm justify-content-end mb-0">
                      {% if da_record_list.has_previous %}
                        <li class="page-item">
                          <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1">
                            <i class="fas fa-angle-double-left"></i>
                          </a>
                        </li>
                        <li class="page-item">
                          <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ da_record_list.previous_page_number }}">
                            <i class="fas fa-angle-left"></i>
                          </a>
                        </li>
                      {% else %}
                        <li class="page-item disabled">
                          <span class="page-link"><i class="fas fa-angle-double-left"></i></span>
                        </li>
                        <li class="page-item disabled">
                          <span class="page-link"><i class="fas fa-angle-left"></i></span>
                        </li>
                      {% endif %}
                      
                      <!-- Page numbers -->
                      {% for page_num in da_record_list.paginator.page_range %}
                        {% if page_num == da_record_list.number %}
                          <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                          </li>
                        {% elif page_num > da_record_list.number|add:'-3' and page_num < da_record_list.number|add:'3' %}
                          <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_num }}">{{ page_num }}</a>
                          </li>
                        {% endif %}
                      {% endfor %}
                      
                      {% if da_record_list.has_next %}
                        <li class="page-item">
                          <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ da_record_list.next_page_number }}">
                            <i class="fas fa-angle-right"></i>
                          </a>
                        </li>
                        <li class="page-item">
                          <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ da_record_list.paginator.num_pages }}">
                            <i class="fas fa-angle-double-right"></i>
                          </a>
                        </li>
                      {% else %}
                        <li class="page-item disabled">
                          <span class="page-link"><i class="fas fa-angle-right"></i></span>
                        </li>
                        <li class="page-item disabled">
                          <span class="page-link"><i class="fas fa-angle-double-right"></i></span>
                        </li>
                      {% endif %}
                    </ul>
                  </nav>
                </div>
              </div>
            </div>
          {% endif %}
        </div>
      
      {% else %}
        <!-- No Results Found -->
        <div class="card">
          <div class="card-body text-center py-5">
            <div class="mb-3">
              <i class="fas fa-child fa-3x text-muted"></i>
            </div>
            <h4 class="text-muted mb-3">No Developmental Assessments Found</h4>
            <p class="text-muted mb-4">
              {% if request.GET %}
                No developmental assessments match your search criteria. Try adjusting your filters.
              {% else %}
                No developmental assessment records have been created yet.
              {% endif %}
            </p>
            <div class="btn-group" role="group">
              {% if patient %}
                <a href="{% url 'da-assessment-manager' %}" class="btn btn-outline-primary">
                  <i class="fas fa-list mr-1"></i>View All Assessments
                </a>
              {% else %}
                <a href="{% url 'da-assessment-manager' %}" class="btn btn-outline-primary">
                  <i class="fas fa-refresh mr-1"></i>Reset Filters
                </a>
              {% endif %}
              <a href="{% url 'home' %}" class="btn btn-primary">
                <i class="fas fa-home mr-1"></i>Go to Dashboard
              </a>
            </div>
          </div>
        </div>
      {% endif %}
      
  </section>
</div>

<!-- Custom Styles -->
<style>
.small-box .inner h3 {
  font-size: 2.2rem;
  font-weight: bold;
}

.badge {
  font-size: 0.85em;
}

.table td {
  vertical-align: middle;
}

.dropdown-menu {
  min-width: 200px;
}

.dropdown-item i {
  width: 20px;
  text-align: center;
}

.user-panel-info a {
  color: #495057;
}

.user-panel-info a:hover {
  color: #007bff;
}

.assessment-date {
  white-space: nowrap;
}

.age-info {
  white-space: nowrap;
}

.assessor-info {
  white-space: nowrap;
}

.quick-search-highlight {
  background-color: yellow;
  font-weight: bold;
}

.card-tools .input-group {
  width: auto;
}

/* Developmental status styling */
.badge-success {
  background-color: #28a745;
}

.badge-warning {
  background-color: #ffc107;
  color: #212529;
}

.text-success {
  color: #28a745 !important;
}

.text-warning {
  color: #856404 !important;
}

@media (max-width: 768px) {
  .table-responsive {
    border: none;
  }
  
  .small-box .inner h3 {
    font-size: 1.8rem;
  }
  
  .badge {
    font-size: 0.75em;
  }
  
  .btn-group .dropdown-toggle {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
  }
  
  .assessment-date,
  .age-info,
  .assessor-info {
    white-space: normal;
  }
}

.dataTables_info {
  font-size: 0.875rem;
  color: #6c757d;
}

.pagination-sm .page-link {
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
}

.content-header h1 {
  margin: 0;
  font-size: 1.8rem;
}

/* Highlight rows with developmental delays */
tr[data-da-id] .badge-warning {
  animation: subtle-pulse 3s infinite;
}

@keyframes subtle-pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4);
  }
  70% {
    box-shadow: 0 0 0 5px rgba(255, 193, 7, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
  }
}
</style>

<!-- Custom JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    $('[data-toggle="tooltip"]').tooltip();
    
    // Quick search functionality
    const quickSearch = document.getElementById('quickSearch');
    const table = document.getElementById('daTable');
    const tbody = table.querySelector('tbody');
    const originalRows = Array.from(tbody.querySelectorAll('tr'));
    
    if (quickSearch) {
        quickSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                // Show all rows
                originalRows.forEach(row => {
                    tbody.appendChild(row);
                    row.style.display = '';
                    // Remove highlight
                    row.querySelectorAll('.quick-search-highlight').forEach(el => {
                        el.outerHTML = el.innerHTML;
                    });
                });
                return;
            }
            
            // Filter and highlight matching rows
            let visibleRows = 0;
            originalRows.forEach(row => {
                const rowText = row.textContent.toLowerCase();
                const shouldShow = rowText.includes(searchTerm);
                
                if (shouldShow) {
                    // Highlight matching text
                    const cells = row.querySelectorAll('td');
                    cells.forEach(cell => {
                        if (!cell.querySelector('.btn-group')) { // Skip action column
                            const cellText = cell.innerHTML;
                            const regex = new RegExp(`(${searchTerm})`, 'gi');
                            cell.innerHTML = cellText.replace(regex, '<span class="quick-search-highlight">$1</span>');
                        }
                    });
                    
                    row.style.display = '';
                    tbody.appendChild(row);
                    visibleRows++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Show "no results" message if no matches
            let noResultsRow = tbody.querySelector('.no-results-row');
            if (visibleRows === 0 && !noResultsRow) {
                noResultsRow = document.createElement('tr');
                noResultsRow.className = 'no-results-row';
                noResultsRow.innerHTML = `
                    <td colspan="8" class="text-center py-4 text-muted">
                        <i class="fas fa-search fa-2x mb-2 d-block"></i>
                        No developmental assessments match "${searchTerm}"
                    </td>
                `;
                tbody.appendChild(noResultsRow);
            } else if (visibleRows > 0 && noResultsRow) {
                noResultsRow.remove();
            }
        });
    }
    
    // Auto-expand search card if there are search parameters
    const urlParams = new URLSearchParams(window.location.search);
    const hasSearchParams = urlParams.has('search_patient') || urlParams.has('development_status') || 
                           urlParams.has('age_range') || urlParams.has('date_range') || urlParams.has('assessor');
    
    if (hasSearchParams) {
        const searchCard = document.querySelector('.collapsed-card');
        if (searchCard) {
            searchCard.classList.remove('collapsed-card');
            searchCard.querySelector('.card-body').style.display = 'block';
            searchCard.querySelector('.card-tools .fa-plus').classList.replace('fa-plus', 'fa-minus');
        }
    }
    
    // Form submission handler to preserve search parameters
    const searchForm = document.getElementById('searchForm');
    if (searchForm) {
        searchForm.addEventListener('submit', function(e) {
            // Remove empty form fields to clean up URL
            const formData = new FormData(this);
            const cleanedData = new URLSearchParams();
            
            for (let [key, value] of formData.entries()) {
                if (value && value.trim() !== '') {
                    cleanedData.append(key, value);
                }
            }
            
            // Redirect with clean URL
            e.preventDefault();
            const newUrl = `${window.location.pathname}${cleanedData.toString() ? '?' + cleanedData.toString() : ''}`;
            window.location.href = newUrl;
        });
    }
    
    // Delete confirmation with enhanced UX
    document.querySelectorAll('[onclick*="confirm"]').forEach(link => {
        link.removeAttribute('onclick');
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (confirm('Are you sure you want to delete this developmental assessment? This action cannot be undone.')) {
                window.location.href = this.href;
            }
        });
    });
    
    // Highlight rows with developmental delays
    document.querySelectorAll('.badge-warning').forEach(badge => {
        if (badge.textContent.includes('Delay')) {
            const row = badge.closest('tr');
            if (row) {
                row.style.background = 'rgba(255, 193, 7, 0.05)';
            }
        }
    });
    
    // Age calculation and display enhancement
    document.querySelectorAll('.age-info .badge').forEach(badge => {
        const months = parseInt(badge.textContent);
        if (months >= 0 && months <= 6) {
            badge.classList.remove('badge-info');
            badge.classList.add('badge-primary');
        } else if (months >= 24) {
            badge.classList.remove('badge-info');
            badge.classList.add('badge-secondary');
        }
    });
});
</script>

{% endblock main_content %}
