{% extends 'src/base.html' %}
{% block title %}HINE Records Manager{% endblock title%}

{% block main_content %}

<div class="container-fluid">

</br>

<!-- Header Section -->
<div class="row mb-3">
  <div class="col-md-8">
    <h2 class="mb-0">
      <i class="fas fa-brain mr-2 text-info"></i>HINE Records Manager
      {% if patient %}
        <small class="text-muted">
          <i class="fas fa-user mr-1"></i>Patient: {{patient.baby_name}}
        </small>
      {% endif %}
    </h2>
  </div>
  <div class="col-md-4">
    <div class="d-flex justify-content-end">
      {% if patient %}
        <a href="{% url 'hine-assessment-add' patient.id %}" class="btn btn-success mr-2">
          <i class="fas fa-plus mr-1"></i>New Assessment
        </a>
        <a href="{% url 'view-patient' patient.id %}" class="btn btn-outline-primary">
          <i class="fas fa-arrow-left mr-1"></i>Back to Patient
        </a>
      {% else %}
        <a href="{% url 'manage-patients' %}" class="btn btn-outline-info">
          <i class="fas fa-users mr-1"></i>Patients
        </a>
      {% endif %}
    </div>
  </div>
</div>

<!-- Statistics Cards -->
{% if hine_record_list %}
<div class="row mb-4">
  <div class="col-lg-3 col-md-6">
    <div class="small-box bg-info">
      <div class="inner">
        <h3>{{ hine_record_list.paginator.count }}</h3>
        <p>Total Records</p>
      </div>
      <div class="icon">
        <i class="fas fa-clipboard-check"></i>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6">
    <div class="small-box bg-success">
      <div class="inner">
        <h3 id="normal-count">0</h3>
        <p>Normal Range</p>
      </div>
      <div class="icon">
        <i class="fas fa-check-circle"></i>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6">
    <div class="small-box bg-warning">
      <div class="inner">
        <h3 id="moderate-count">0</h3>
        <p>Moderate Concern</p>
      </div>
      <div class="icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6">
    <div class="small-box bg-danger">
      <div class="inner">
        <h3 id="significant-count">0</h3>
        <p>Significant Concern</p>
      </div>
      <div class="icon">
        <i class="fas fa-exclamation-circle"></i>
      </div>
    </div>
  </div>
</div>

<!-- Search and Filter Section -->
<div class="card mb-3">
  <div class="card-body">
    <div class="row">
      <div class="col-md-4">
        <div class="form-group">
          <label for="searchInput">Search Records:</label>
          <input type="text" class="form-control" id="searchInput" placeholder="Search by patient name, assessor, or score...">
        </div>
      </div>
      <div class="col-md-3">
        <div class="form-group">
          <label for="scoreFilter">Filter by Score Range:</label>
          <select class="form-control" id="scoreFilter">
            <option value="">All Scores</option>
            <option value="normal">Normal (â‰¥60)</option>
            <option value="moderate">Moderate (40-59)</option>
            <option value="significant">Significant (<40)</option>
          </select>
        </div>
      </div>
      <div class="col-md-3">
        <div class="form-group">
          <label for="dateFilter">Filter by Date:</label>
          <select class="form-control" id="dateFilter">
            <option value="">All Dates</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
            <option value="year">This Year</option>
          </select>
        </div>
      </div>
      <div class="col-md-2">
        <div class="form-group">
          <label>&nbsp;</label>
          <button type="button" class="btn btn-outline-secondary btn-block" id="clearFilters">
            <i class="fas fa-times mr-1"></i>Clear
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Main Data Table -->
<div class="card">
  <div class="card-header bg-light">
    <h5 class="card-title mb-0">
      <i class="fas fa-table mr-2"></i>HINE Assessment Records
      <span class="badge badge-info ml-2" id="recordCount">{{ hine_record_list.paginator.count }} records</span>
    </h5>
  </div>
  
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover table-striped mb-0" id="hineTable">
        <thead class="thead-light">
          <tr>
            <th width="60">ID</th>
            <th width="100">Status</th>
            <th>Patient Name</th>
            <th width="100">Score</th>
            <th width="120">Assessment Date</th>
            <th width="120">Age at Assessment</th>
            <th>Assessed by</th>
            <th width="80">Info</th>
            <th width="120">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for HINERecord in hine_record_list %}
          <tr data-score="{{ HINERecord.score }}" data-date="{{ HINERecord.date_of_assessment|date:'Y-m-d' }}" data-patient="{{ HINERecord.patient.baby_name|lower }}" data-assessor="{{ HINERecord.assessment_done_by|lower }}">
            <td>
              <span class="badge badge-secondary">#{{ HINERecord.id }}</span>
            </td>
            <td>
              <div class="d-flex align-items-center">
                {% if HINERecord.isBookmarked %}
                  <a href="{% url 'bookmark-view' HINERecord.isBookmarked.id %}" 
                     data-toggle="tooltip" data-placement="top" title="View Bookmark" 
                     class="text-warning mr-2">
                    <i class="fas fa-bookmark"></i>
                  </a>
                {% endif %}
                
                {% if HINERecord.score >= 60 %}
                  <span class="badge badge-success" data-toggle="tooltip" title="Normal Range">
                    <i class="fas fa-check-circle mr-1"></i>Normal
                  </span>
                {% elif HINERecord.score >= 40 %}
                  <span class="badge badge-warning" data-toggle="tooltip" title="Moderate Concern">
                    <i class="fas fa-exclamation-triangle mr-1"></i>Moderate
                  </span>
                {% else %}
                  <span class="badge badge-danger" data-toggle="tooltip" title="Significant Concern">
                    <i class="fas fa-exclamation-circle mr-1"></i>Significant
                  </span>
                {% endif %}
              </div>
            </td>
            <td>
              <a href="{% url 'view-patient' HINERecord.patient.id %}" class="text-decoration-none">
                <strong>{{ HINERecord.patient.baby_name }}</strong>
              </a>
              {% if HINERecord.patient.bht %}
                <br><small class="text-muted">BHT: {{ HINERecord.patient.bht }}</small>
              {% endif %}
            </td>
            <td>
              <div class="score-display">
                <span class="h5 mb-0 
                  {% if HINERecord.score >= 60 %}text-success
                  {% elif HINERecord.score >= 40 %}text-warning
                  {% else %}text-danger{% endif %}">
                  {{ HINERecord.score }}
                </span>
                <small class="text-muted d-block">/78</small>
              </div>
            </td>
            <td>
              <span data-toggle="tooltip" title="{{ HINERecord.date_of_assessment|date:'F d, Y g:i A' }}">
                {{ HINERecord.date_of_assessment|date:"M d, Y" }}
              </span>
            </td>
            <td>
              <span class="badge badge-info">{{ HINERecord.getAssessmentAgeInMonths }}</span>
            </td>
            <td>
              <span class="text-truncate" style="max-width: 150px;" data-toggle="tooltip" title="{{ HINERecord.assessment_done_by }}">
                {{ HINERecord.assessment_done_by }}
              </span>
            </td>
            <td>
              <i class="fas fa-info-circle text-info" style="cursor: pointer;" 
                 data-toggle="tooltip" data-html="true" data-placement="left"
                 title="<strong>Created:</strong> {{ HINERecord.added_by }}<br>{{ HINERecord.added_on|date:'M d, Y g:i A' }}{% if HINERecord.last_edit_by %}<br><strong>Last edited:</strong> {{HINERecord.last_edit_by}}<br>{{HINERecord.last_edit_on|date:'M d, Y g:i A'}}{% endif %}"></i>
            </td>
            <td>
              <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="fas fa-cogs"></i>
                </button>
                <div class="dropdown-menu dropdown-menu-right">
                  <a class="dropdown-item" href="{% url 'hine-assessment-view' HINERecord.id %}">
                    <i class="fas fa-eye mr-2"></i>View Record
                  </a>
                  <a class="dropdown-item" href="{% url 'hine-assessment-edit' HINERecord.id %}">
                    <i class="fas fa-edit mr-2"></i>Edit Record
                  </a>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="{% url 'view-patient' HINERecord.patient.id %}">
                    <i class="fas fa-user mr-2"></i>View Patient
                  </a>
                  {% if not patient %}
                  <a class="dropdown-item" href="{% url 'hine-assessment-manager-patient' HINERecord.patient.id %}">
                    <i class="fas fa-list mr-2"></i>Patient's HINE Records
                  </a>
                  {% endif %}
                  <div class="dropdown-divider"></div>
                  {% if HINERecord.isBookmarked %}
                  <a class="dropdown-item" href="{% url 'bookmark-view' HINERecord.isBookmarked.id %}">
                    <i class="fas fa-bookmark mr-2"></i>View Bookmark
                  </a>
                  {% else %}
                  <a class="dropdown-item" href="{% url 'bookmark-add' HINERecord.id 'HINE' %}">
                    <i class="fas fa-bookmark mr-2"></i>Add Bookmark
                  </a>
                  {% endif %}
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item text-danger" href="{% url 'hine-assessment-delete_start' HINERecord.id %}" onclick="return confirm('Are you sure you want to delete this HINE record?')">
                    <i class="fas fa-trash mr-2"></i>Delete Record
                  </a>
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Pagination -->
<div class="d-flex justify-content-between align-items-center mt-4">
  <div>
    <small class="text-muted">
      Showing {{ hine_record_list.start_index }} to {{ hine_record_list.end_index }} 
      of {{ hine_record_list.paginator.count }} records
    </small>
  </div>
  <nav aria-label="HINE Records Pagination">
    <ul class="pagination pagination-sm mb-0">
      {% if hine_record_list.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page=1" tabindex="-1">
            <i class="fas fa-angle-double-left"></i>
          </a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page={{ hine_record_list.previous_page_number }}" tabindex="-1">
            <i class="fas fa-angle-left"></i>
          </a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <span class="page-link"><i class="fas fa-angle-double-left"></i></span>
        </li>
        <li class="page-item disabled">
          <span class="page-link"><i class="fas fa-angle-left"></i></span>
        </li>
      {% endif %}

      <li class="page-item active">
        <span class="page-link">
          Page {{ hine_record_list.number }} of {{ hine_record_list.paginator.num_pages }}
        </span>
      </li>

      {% if hine_record_list.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ hine_record_list.next_page_number }}">
            <i class="fas fa-angle-right"></i>
          </a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page={{ hine_record_list.paginator.num_pages }}">
            <i class="fas fa-angle-double-right"></i>
          </a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <span class="page-link"><i class="fas fa-angle-right"></i></span>
        </li>
        <li class="page-item disabled">
          <span class="page-link"><i class="fas fa-angle-double-right"></i></span>
        </li>
      {% endif %}
    </ul>
  </nav>
</div>

{% else %}
<!-- No Records Found -->
<div class="text-center py-5">
  <div class="mb-4">
    <i class="fas fa-brain fa-4x text-muted"></i>
  </div>
  <h4 class="text-muted">No HINE Records Found</h4>
  <p class="text-muted mb-4">
    {% if patient %}
      No HINE assessment records found for {{ patient.baby_name }}.
    {% else %}
      No HINE assessment records found in the system.
    {% endif %}
  </p>
  {% if patient %}
    <a href="{% url 'hine-assessment-add' patient.id %}" class="btn btn-success">
      <i class="fas fa-plus mr-2"></i>Create First HINE Assessment
    </a>
  {% else %}
    <a href="{% url 'manage-patients' %}" class="btn btn-primary">
      <i class="fas fa-users mr-2"></i>View Patients
    </a>
  {% endif %}
</div>
{% endif %}

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    $('[data-toggle="tooltip"]').tooltip();
    
    // Calculate statistics
    updateStatistics();
    
    // Search functionality
    const searchInput = document.getElementById('searchInput');
    const scoreFilter = document.getElementById('scoreFilter');
    const dateFilter = document.getElementById('dateFilter');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const table = document.getElementById('hineTable');
    
    if (searchInput && table) {
        searchInput.addEventListener('keyup', filterTable);
        if (scoreFilter) scoreFilter.addEventListener('change', filterTable);
        if (dateFilter) dateFilter.addEventListener('change', filterTable);
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', function() {
                searchInput.value = '';
                if (scoreFilter) scoreFilter.value = '';
                if (dateFilter) dateFilter.value = '';
                filterTable();
            });
        }
    }
    
    function filterTable() {
        const searchTerm = searchInput.value.toLowerCase();
        const scoreFilterValue = scoreFilter ? scoreFilter.value : '';
        const dateFilterValue = dateFilter ? dateFilter.value : '';
        const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        let visibleCount = 0;
        
        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const score = parseInt(row.dataset.score);
            const date = new Date(row.dataset.date);
            const patient = row.dataset.patient || '';
            const assessor = row.dataset.assessor || '';
            
            let showRow = true;
            
            // Search filter
            if (searchTerm) {
                const searchText = (patient + ' ' + assessor + ' ' + score).toLowerCase();
                if (!searchText.includes(searchTerm)) {
                    showRow = false;
                }
            }
            
            // Score filter
            if (scoreFilterValue && showRow) {
                if (scoreFilterValue === 'normal' && score < 60) showRow = false;
                if (scoreFilterValue === 'moderate' && (score < 40 || score >= 60)) showRow = false;
                if (scoreFilterValue === 'significant' && score >= 40) showRow = false;
            }
            
            // Date filter
            if (dateFilterValue && showRow) {
                const today = new Date();
                const oneWeekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                const oneMonthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
                const oneYearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
                
                switch(dateFilterValue) {
                    case 'today':
                        if (date.toDateString() !== today.toDateString()) showRow = false;
                        break;
                    case 'week':
                        if (date < oneWeekAgo) showRow = false;
                        break;
                    case 'month':
                        if (date < oneMonthAgo) showRow = false;
                        break;
                    case 'year':
                        if (date < oneYearAgo) showRow = false;
                        break;
                }
            }
            
            row.style.display = showRow ? '' : 'none';
            if (showRow) visibleCount++;
        }
        
        // Update record count
        const recordCount = document.getElementById('recordCount');
        if (recordCount) {
            recordCount.textContent = `${visibleCount} records`;
        }
    }
    
    function updateStatistics() {
        const rows = document.querySelectorAll('#hineTable tbody tr');
        let normal = 0, moderate = 0, significant = 0;
        
        rows.forEach(row => {
            const score = parseInt(row.dataset.score);
            if (score >= 60) normal++;
            else if (score >= 40) moderate++;
            else significant++;
        });
        
        const normalCount = document.getElementById('normal-count');
        const moderateCount = document.getElementById('moderate-count');
        const significantCount = document.getElementById('significant-count');
        
        if (normalCount) normalCount.textContent = normal;
        if (moderateCount) moderateCount.textContent = moderate;
        if (significantCount) significantCount.textContent = significant;
    }
});
</script>

<style>
.small-box {
    border-radius: 0.375rem;
    box-shadow: 0 0 1px rgba(0,0,0,.125), 0 1px 3px rgba(0,0,0,.2);
    display: block;
    margin-bottom: 20px;
    position: relative;
}

.small-box > .inner {
    padding: 10px;
}

.small-box .icon {
    color: rgba(0,0,0,.15);
    z-index: 0;
}

.small-box .icon > i {
    font-size: 70px;
    position: absolute;
    right: 15px;
    top: 15px;
    transition: transform .3s linear;
}

.small-box:hover .icon > i {
    transform: scale(1.1);
}

.score-display {
    text-align: center;
}

.table th {
    border-top: none;
    font-weight: 600;
}

.table-responsive {
    border-radius: 0.375rem;
}

@media (max-width: 768px) {
    .small-box .icon {
        display: none;
    }
    
    .table-responsive {
        font-size: 0.875rem;
    }
}
</style>

{% endblock main_content %}
