{% extends 'src/base.html' %}
{% block title %} User - Change Password {% endblock title %}
{% block main_content %}

<!-- Professional Change Password Page for Logged-in Users -->
<div class="container-fluid mt-3">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-6">
            <!-- Professional Card Header -->
            <div class="card shadow-sm">
                <div class="card-header bg-gradient-primary text-white">
                    <div class="d-flex align-items-center">
                        <div class="card-icon mr-3">
                            <i class="fas fa-key fa-2x"></i>
                        </div>
                        <div>
                            <h4 class="card-title mb-0">Change Password</h4>
                            <small class="card-subtitle">Update your account password securely</small>
                        </div>
                    </div>
                </div>
                
                <!-- Professional Card Body -->
                <div class="card-body p-4">
                    <!-- Messages Display -->
                    {% include 'src/messages.html' %}
                    
                    <!-- User Information Section -->
                    <div class="user-info-section mb-4">
                        <h6 class="text-muted mb-3">
                            <i class="fas fa-user mr-2"></i>Account Information
                        </h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="info-item">
                                    <label class="info-label">Username</label>
                                    <div class="info-value">{{custom_user.username}}</div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="info-item">
                                    <label class="info-label">User Type</label>
                                    <div class="info-value">{{custom_user.possition}}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- Password Change Form -->
                    <div class="password-form-section">
                        <h6 class="text-muted mb-4">
                            <i class="fas fa-lock mr-2"></i>Password Settings
                        </h6>
                        
                        <form action="{% url 'user-change-password' %}" method="POST" id="changePasswordForm">
                            {% csrf_token %}
                            
                            <!-- Current Password -->
                            <div class="form-group mb-4">
                                <label for="id_old_password" class="form-label">
                                    <i class="fas fa-unlock-alt mr-2 text-muted"></i>Current Password
                                </label>
                                <div class="password-input-wrapper">
                                    <input type="password" 
                                           class="form-control form-control-lg" 
                                           id="id_old_password"
                                           name="old_password" 
                                           placeholder="Enter your current password"
                                           required>
                                    <span class="password-toggle-admin" data-target="id_old_password">
                                        <i class="fas fa-eye"></i>
                                    </span>
                                </div>
                            </div>
                            
                            <!-- New Password -->
                            <div class="form-group mb-4">
                                <label for="id_new_password1" class="form-label">
                                    <i class="fas fa-lock mr-2 text-primary"></i>New Password
                                </label>
                                <div class="password-input-wrapper">
                                    <input type="password" 
                                           class="form-control form-control-lg" 
                                           id="id_new_password1"
                                           name="new_password1" 
                                           placeholder="Enter your new password"
                                           required>
                                    <span class="password-toggle-admin" data-target="id_new_password1">
                                        <i class="fas fa-eye"></i>
                                    </span>
                                </div>
                                <div class="password-strength-indicator mt-2" id="passwordStrength">
                                    <div class="strength-bar"></div>
                                    <small class="strength-text">Password strength will appear here</small>
                                </div>
                            </div>
                            
                            <!-- Confirm New Password -->
                            <div class="form-group mb-4">
                                <label for="id_new_password2" class="form-label">
                                    <i class="fas fa-shield-alt mr-2 text-success"></i>Confirm New Password
                                </label>
                                <div class="password-input-wrapper">
                                    <input type="password" 
                                           class="form-control form-control-lg" 
                                           id="id_new_password2"
                                           name="new_password2" 
                                           placeholder="Re-enter your new password"
                                           required>
                                    <span class="password-toggle-admin" data-target="id_new_password2">
                                        <i class="fas fa-eye"></i>
                                    </span>
                                </div>
                                <div class="match-indicator mt-2" id="passwordMatch">
                                    <small class="match-text">Password confirmation will appear here</small>
                                </div>
                            </div>
                            
                            <!-- Security Tips -->
                            <div class="alert alert-info border-0 mb-4" role="alert">
                                <h6 class="alert-heading">
                                    <i class="fas fa-info-circle mr-2"></i>Password Security Tips
                                </h6>
                                <ul class="mb-0 small">
                                    <li>Use at least 8 characters with a mix of letters, numbers, and symbols</li>
                                    <li>Don't use common words or personal information</li>
                                    <li>Use a unique password for this account</li>
                                </ul>
                            </div>
                            
                            <!-- Form Actions -->
                            <div class="form-actions pt-3">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <button type="submit" class="btn btn-primary btn-lg btn-block">
                                            <i class="fas fa-check mr-2"></i>Update Password
                                        </button>
                                    </div>
                                    <div class="col-sm-6">
                                        <button type="button" class="btn btn-outline-secondary btn-lg btn-block" onclick="history.back()">
                                            <i class="fas fa-arrow-left mr-2"></i>Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Professional Styling for Change Password -->
<style>
/* Card Styling */
.card {
    border: none;
    border-radius: 15px;
    overflow: hidden;
}

.card-header.bg-gradient-primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
    border: none;
    padding: 1.5rem;
}

.card-icon {
    width: 60px;
    height: 60px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
}

.card-title {
    font-size: 1.5rem;
    font-weight: 600;
}

.card-subtitle {
    opacity: 0.9;
}

/* User Info Section */
.user-info-section {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
}

.info-item {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    border-left: 4px solid #007bff;
}

.info-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.25rem;
    display: block;
}

.info-value {
    font-size: 1rem;
    font-weight: 500;
    color: #2c3e50;
}

/* Form Styling */
.form-label {
    font-size: 0.9rem;
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.5rem;
}

.form-control-lg {
    border-radius: 8px;
    border: 2px solid #e9ecef;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
    transition: all 0.3s ease;
}

.form-control-lg:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.15);
}

/* Password Input with Toggle */
.password-input-wrapper {
    position: relative;
}

.password-toggle-admin {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    color: #adb5bd;
    transition: color 0.3s ease;
    z-index: 10;
}

.password-toggle-admin:hover {
    color: #007bff;
}

/* Password Strength Indicator */
.password-strength-indicator {
    margin-top: 0.5rem;
}

.strength-bar {
    height: 4px;
    border-radius: 2px;
    background: #e9ecef;
    transition: all 0.3s ease;
}

.strength-bar.weak {
    width: 25%;
    background: #dc3545;
}

.strength-bar.fair {
    width: 50%;
    background: #ffc107;
}

.strength-bar.good {
    width: 75%;
    background: #17a2b8;
}

.strength-bar.strong {
    width: 100%;
    background: #28a745;
}

.strength-text {
    color: #6c757d;
    font-size: 0.8rem;
}

/* Password Match Indicator */
.match-indicator .match-text {
    color: #6c757d;
    font-size: 0.8rem;
}

.match-indicator.match .match-text {
    color: #28a745;
}

.match-indicator.no-match .match-text {
    color: #dc3545;
}

/* Button Styling */
.btn-primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    border: none;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 123, 255, 0.2);
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
    background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
}

.btn-outline-secondary {
    border: 2px solid #6c757d;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-outline-secondary:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(108, 117, 125, 0.3);
}

/* Responsive Design */
@media (max-width: 576px) {
    .form-actions .row .col-sm-6 {
        margin-bottom: 0.5rem;
    }
    
    .card-header {
        padding: 1rem;
    }
    
    .card-body {
        padding: 1.5rem !important;
    }
    
    .user-info-section {
        padding: 1rem;
    }
}
</style>

<!-- Enhanced JavaScript for Password Change -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Password visibility toggles
    const passwordToggles = document.querySelectorAll('.password-toggle-admin');
    passwordToggles.forEach(toggle => {
        toggle.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const passwordField = document.getElementById(targetId);
            
            if (passwordField) {
                const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordField.setAttribute('type', type);
                
                const icon = this.querySelector('i');
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            }
        });
    });
    
    // Password strength checker
    const newPassword = document.querySelector('#id_new_password1');
    const strengthIndicator = document.querySelector('#passwordStrength');
    const strengthBar = strengthIndicator.querySelector('.strength-bar');
    const strengthText = strengthIndicator.querySelector('.strength-text');
    
    newPassword.addEventListener('input', function() {
        const password = this.value;
        const strength = calculatePasswordStrength(password);
        
        // Remove all strength classes
        strengthBar.className = 'strength-bar';
        
        if (password.length === 0) {
            strengthText.textContent = 'Password strength will appear here';
            strengthText.style.color = '#6c757d';
            return;
        }
        
        switch(strength.level) {
            case 1:
                strengthBar.classList.add('weak');
                strengthText.textContent = 'Weak password';
                strengthText.style.color = '#dc3545';
                break;
            case 2:
                strengthBar.classList.add('fair');
                strengthText.textContent = 'Fair password';
                strengthText.style.color = '#ffc107';
                break;
            case 3:
                strengthBar.classList.add('good');
                strengthText.textContent = 'Good password';
                strengthText.style.color = '#17a2b8';
                break;
            case 4:
                strengthBar.classList.add('strong');
                strengthText.textContent = 'Strong password';
                strengthText.style.color = '#28a745';
                break;
        }
    });
    
    // Password match checker
    const confirmPassword = document.querySelector('#id_new_password2');
    const matchIndicator = document.querySelector('#passwordMatch');
    const matchText = matchIndicator.querySelector('.match-text');
    
    function checkPasswordMatch() {
        const password = newPassword.value;
        const confirm = confirmPassword.value;
        
        matchIndicator.className = 'match-indicator mt-2';
        
        if (confirm.length === 0) {
            matchText.textContent = 'Password confirmation will appear here';
            matchText.style.color = '#6c757d';
        } else if (password === confirm) {
            matchIndicator.classList.add('match');
            matchText.textContent = '✓ Passwords match';
            matchText.style.color = '#28a745';
        } else {
            matchIndicator.classList.add('no-match');
            matchText.textContent = '✗ Passwords do not match';
            matchText.style.color = '#dc3545';
        }
    }
    
    newPassword.addEventListener('input', checkPasswordMatch);
    confirmPassword.addEventListener('input', checkPasswordMatch);
    
    // Form submission
    const form = document.querySelector('#changePasswordForm');
    const submitBtn = form.querySelector('button[type="submit"]');
    
    form.addEventListener('submit', function(e) {
        // Check if passwords match before submitting
        const password = newPassword.value;
        const confirm = confirmPassword.value;
        
        if (password !== confirm) {
            e.preventDefault();
            alert('Passwords do not match. Please check and try again.');
            return;
        }
        
        // Add loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Updating...';
        submitBtn.disabled = true;
        
        // Re-enable after delay for error handling
        setTimeout(() => {
            submitBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Update Password';
            submitBtn.disabled = false;
        }, 5000);
    });
});

function calculatePasswordStrength(password) {
    let score = 0;
    let feedback = [];
    
    // Length check
    if (password.length >= 8) score++;
    else feedback.push('Use at least 8 characters');
    
    // Character variety checks
    if (/[A-Z]/.test(password)) score++;
    else feedback.push('Add uppercase letters');
    
    if (/[a-z]/.test(password)) score++;
    else feedback.push('Add lowercase letters');
    
    if (/[0-9]/.test(password)) score++;
    else feedback.push('Add numbers');
    
    if (/[^A-Za-z0-9]/.test(password)) score++;
    else feedback.push('Add special characters');
    
    return {
        level: Math.min(score, 4),
        feedback: feedback
    };
}
</script>

{% endblock main_content %}