{% extends 'src/base.html' %}
{% block title %}User - Update Profile{% endblock %}

{% block main_content %}
    </br>
<div class="container-sm">
<div class="col-sm">

      <div class="card">
        <div class="card-header">
          <h3 class="card-title"><i class="fas fa-user-edit"></i> Update Profile</h3>
          <div class="card-tools">
            <span class="badge badge-info">Required fields are marked with *</span>
          </div>
        </div>
        <!-- /.card-header -->
        <div class="card-body">

        <form action="{% url 'user-edit' selected_user.pk %}" method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>

            {% csrf_token %}

            <div class="container">{% include 'src/form_error.html' %}</div>

            <!-- Basic Information Section -->
            <div class="card mb-3">
              <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-user"></i> Basic Information</h5>
              </div>
              <div class="card-body">
                <div class="form-group row">
                  <label class="col-form-label col-sm-3">Position <span class="text-danger">*</span> : </label>
                  <div class="col-sm-9">{{form.position}}</div>
                  <div class="invalid-feedback"> Please choose a position.</div>
                </div>
                
                <div class="form-group row">
                  <label class="col-form-label col-sm-3">Username <span class="text-danger">*</span> : </label>
                  <div class="col-sm-9">{{form.username}}</div>
                  <div class="invalid-feedback"> Please choose a username.</div>
                </div>

                <div class="form-group row">
                  <label class="col-sm-3 col-form-label">First Name <span class="text-danger">*</span> : </label>
                  <div class="col-sm-9">{{form.first_name}}</div>
                </div>

                <div class="form-group row">
                  <label class="col-sm-3 col-form-label">Last Name : </label>
                  <div class="col-sm-9">{{form.last_name}}</div>
                </div>

                <div class="form-group row">
                  <label class="col-sm-3 col-form-label">Email <span class="text-danger">*</span> : </label>
                  <div class="col-sm-9">{{form.email}}</div>
                </div>

                <div class="form-group row">
                  <label for="formFile" class="col-sm-3 col-form-label">Profile Picture : </label>
                  <div class="col-sm-9">{{form.profile_picture}}</div>
                  <small class="form-text text-muted">Supported formats: JPG, JPEG, PNG. Max size: 5MB</small>
                </div>
              </div>
            </div>

            <!-- Contact Information Section -->
            <div class="card mb-3">
              <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-phone"></i> Contact Information</h5>
              </div>
              <div class="card-body">
                <div class="form-group row">
                  <label class="col-sm-3 col-form-label">Primary Mobile <span class="text-danger">*</span> : </label>
                  <div class="col-sm-9">{{form.mobile_primary}}</div>
                </div>

                <div class="form-group row">
                  <label class="col-sm-3 col-form-label">Secondary Mobile : </label>
                  <div class="col-sm-9">{{form.mobile_secondary}}</div>
                </div>

                <div class="form-group row">
                  <label class="col-sm-3 col-form-label">Primary Landline : </label>
                  <div class="col-sm-9">{{form.landline_primary}}</div>
                </div>

                <div class="form-group row">
                  <label class="col-sm-3 col-form-label">Secondary Landline : </label>
                  <div class="col-sm-9">{{form.landline_secondary}}</div>
                </div>
              </div>
            </div>

            <!-- Address Information Section -->
            <div class="card mb-3">
              <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-map-marker-alt"></i> Address Information</h5>
              </div>
              <div class="card-body">
                <div class="form-group row">
                  <label class="col-sm-3 col-form-label">Home Address : </label>
                  <div class="col-sm-9">{{form.home_address}}</div>
                </div>

                <div class="form-group row">
                  <label class="col-sm-3 col-form-label">Station Address : </label>
                  <div class="col-sm-9">{{form.station_address}}</div>
                </div>
              </div>
            </div>

            <!-- Additional Information Section -->
            <div class="card mb-3">
              <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-sticky-note"></i> Additional Information</h5>
              </div>
              <div class="card-body">
                <div class="form-group row">
                  <label class="col-sm-3 col-form-label">Additional Notes : </label>
                  <div class="col-sm-9">{{form.additional_notes}}</div>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="card">
              <div class="card-body">
                <div class="form-group row">
                  <div class="col-sm-3"></div>
                  <div class="col-sm-9">
                    <button type="submit" class="btn btn-primary mr-2">
                      <i class="fas fa-save"></i> Update Profile
                    </button>
                    <a href="{% url 'user-view' selected_user.pk %}" class="btn btn-secondary">
                      <i class="fas fa-times"></i> Cancel
                    </a>
                  </div>
                </div>
              </div>
            </div>
            
        </form>

      </div>
      <!-- /.card-body -->
    </div>
    <!-- /.card -->

    </div>
  </div>

</div>
</div>

{% endblock main_content %}

{% block extra_js %}
<script>
// Form validation
(function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();

// Phone number formatting
function formatPhoneNumber(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.length > 0) {
        if (value.length <= 3) {
            value = value;
        } else if (value.length <= 6) {
            value = value.slice(0, 3) + '-' + value.slice(3);
        } else {
            value = value.slice(0, 3) + '-' + value.slice(3, 6) + '-' + value.slice(6, 10);
        }
    }
    input.value = value;
}

// Add phone formatting to mobile and landline fields
document.addEventListener('DOMContentLoaded', function() {
    const phoneFields = ['mobile_primary', 'mobile_secondary', 'landline_primary', 'landline_secondary'];
    phoneFields.forEach(fieldName => {
        const field = document.querySelector(`input[name="${fieldName}"]`);
        if (field) {
            field.addEventListener('input', function() {
                formatPhoneNumber(this);
            });
        }
    });
});

// Profile picture preview
function previewImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('profile-preview');
            if (!preview) {
                const img = document.createElement('img');
                img.id = 'profile-preview';
                img.style.maxWidth = '200px';
                img.style.maxHeight = '200px';
                img.style.marginTop = '10px';
                img.className = 'img-thumbnail';
                input.parentNode.appendChild(img);
            }
            document.getElementById('profile-preview').src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// Add image preview to profile picture field
document.addEventListener('DOMContentLoaded', function() {
    const profilePicField = document.querySelector('input[name="profile_picture"]');
    if (profilePicField) {
        profilePicField.addEventListener('change', function() {
            previewImage(this);
        });
    }
});
</script>
{% endblock extra_js %}