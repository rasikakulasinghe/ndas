<!-- Delete Attachment Modal -->
<div class="modal fade" id="deleteAttachmentModal" tabindex="-1" role="dialog" aria-labelledby="deleteAttachmentModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header bg-danger text-white">
        <h4 class="modal-title" id="deleteAttachmentModalLabel">
          <i class="fas fa-exclamation-triangle"></i> Confirm Deletion
        </h4>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      
      <!-- Modal Body -->
      <div class="modal-body">
        <div class="alert alert-danger">
          <h5><i class="icon fas fa-ban"></i> Warning!</h5>
          You are about to permanently delete this attachment. This action cannot be undone.
        </div>
        
        <!-- Attachment Details -->
        <div class="row" id="attachment-details-container">
          <!-- Will be populated dynamically -->
        </div>
        
        <hr>
        
        <!-- Password Confirmation Form -->
        <form id="delete-attachment-form">
          {% csrf_token %}
          <input type="hidden" id="attachment-id" name="attachment_id">
          
          <div class="form-group">
            <label for="delete-password">Enter your password to confirm deletion:</label>
            <div class="input-group">
              <div class="input-group-prepend">
                <span class="input-group-text"><i class="fas fa-lock"></i></span>
              </div>
              <input type="password" class="form-control" id="delete-password" name="password" 
                     placeholder="Your account password" required autocomplete="current-password">
            </div>
            <small class="form-text text-muted">This is required for security purposes.</small>
          </div>
          
          <div class="form-check mb-3">
            <input type="checkbox" class="form-check-input" id="delete-confirm-checkbox" required>
            <label class="form-check-label" for="delete-confirm-checkbox">
              I understand that this action is permanent and cannot be undone
            </label>
          </div>
        </form>
      </div>
      
      <!-- Modal Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button type="button" class="btn btn-danger" id="modal-delete-btn" disabled>
          <i class="fas fa-trash"></i> Delete Permanently
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Ensure this runs after all dependencies are loaded
function initializeDeleteModal() {
  console.log('Initializing delete attachment modal script');
  console.log('jQuery version:', $.fn ? $.fn.jquery : 'not loaded');
  console.log('Bootstrap modal available:', typeof $.fn !== 'undefined' && typeof $.fn.modal !== 'undefined');
  
  if (typeof $ === 'undefined' || typeof $.fn.modal === 'undefined') {
    console.error('jQuery or Bootstrap modal not available, retrying in 100ms...');
    setTimeout(initializeDeleteModal, 100);
    return;
  }
  
  let currentAttachmentId = null;
  let currentPatientName = null;
  
  // Test function to check if modal can be opened manually
  window.testDeleteModal = function() {
    console.log('Testing modal...');
    $('#deleteAttachmentModal').modal('show');
  };
  
  // Function to open delete modal with attachment data
  window.openDeleteAttachmentModal = function(attachmentData) {
    console.log('Opening delete modal for attachment:', attachmentData);
    
    try {
      currentAttachmentId = attachmentData.id;
      currentPatientName = attachmentData.patient_name || 'Patient';
      $('#attachment-id').val(attachmentData.id);
      
      // Clear previous data
      $('#delete-password').val('');
      $('#delete-confirm-checkbox').prop('checked', false);
      $('#modal-delete-btn').prop('disabled', true);
      
      // Generate type badge HTML based on attachment type
      let typeBadge = 'Unknown';
      const attachmentType = attachmentData.attachment_type || '';
      
      switch (attachmentType.toLowerCase()) {
        case 'image':
          typeBadge = '<span class="badge badge-primary"><i class="fas fa-image"></i> Image</span>';
          break;
        case 'video':
          typeBadge = '<span class="badge badge-danger"><i class="fas fa-video"></i> Video</span>';
          break;
        case 'pdf':
          typeBadge = '<span class="badge badge-warning"><i class="fas fa-file-pdf"></i> PDF</span>';
          break;
        default:
          typeBadge = `<span class="badge badge-secondary"><i class="fas fa-file"></i> ${attachmentType.charAt(0).toUpperCase() + attachmentType.slice(1)}</span>`;
      }
      
      // Populate attachment details
      const detailsHtml = `
        <div class="col-md-6">
          <dl class="row">
            <dt class="col-sm-5">Patient:</dt>
            <dd class="col-sm-7">${attachmentData.patient_name || 'Unknown'}</dd>
            
            <dt class="col-sm-5">BHT:</dt>
            <dd class="col-sm-7">${attachmentData.patient_bht || "Not assigned"}</dd>
            
            <dt class="col-sm-5">Gender:</dt>
            <dd class="col-sm-7">${attachmentData.patient_gender || 'Unknown'}</dd>
          </dl>
        </div>
        <div class="col-md-6">
          <dl class="row">
            <dt class="col-sm-5">Title:</dt>
            <dd class="col-sm-7">${attachmentData.title || 'Untitled'}</dd>
            
            <dt class="col-sm-5">Type:</dt>
            <dd class="col-sm-7">${typeBadge}</dd>
            
            <dt class="col-sm-5">Uploaded:</dt>
            <dd class="col-sm-7">
              ${attachmentData.created_at || 'Unknown date'}<br>
              <small class="text-muted">by ${attachmentData.added_by || 'Unknown user'}</small>
            </dd>
          </dl>
        </div>
        ${attachmentData.description ? `
          <div class="col-12 mt-3">
            <dt>Description:</dt>
            <dd class="text-muted">${attachmentData.description}</dd>
          </div>
        ` : ''}
      `;
      
      $('#attachment-details-container').html(detailsHtml);
      
      // Check if modal exists
      if ($('#deleteAttachmentModal').length === 0) {
        console.error('Delete attachment modal not found in DOM');
        alert('Modal not found. Please refresh the page and try again.');
        return;
      }
      
      console.log('Showing modal...');
      $('#deleteAttachmentModal').modal('show');
      
      // Focus on password field after modal is shown (only bind once)
      $('#deleteAttachmentModal').off('shown.bs.modal.deleteAttachment').on('shown.bs.modal.deleteAttachment', function() {
        $('#delete-password').focus();
      });
      
    } catch (error) {
      console.error('Error opening delete modal:', error);
      alert('Error opening delete confirmation. Please try again.');
    }
  };
  
  // Enable delete button only when checkbox is checked and password is entered
  function toggleDeleteButton() {
    const passwordFilled = $('#delete-password').val().trim().length > 0;
    const checkboxChecked = $('#delete-confirm-checkbox').is(':checked');
    $('#modal-delete-btn').prop('disabled', !(passwordFilled && checkboxChecked));
  }
  
  // Event listeners for form validation
  $('#delete-password, #delete-confirm-checkbox').on('input change keyup', toggleDeleteButton);
  
  // Handle delete button click
  $('#modal-delete-btn').on('click', function() {
    if (!currentAttachmentId) {
      alert('Error: No attachment selected for deletion.');
      return;
    }
    
    const password = $('#delete-password').val().trim();
    if (!password) {
      alert('Please enter your password.');
      $('#delete-password').focus();
      return;
    }
    
    if (!$('#delete-confirm-checkbox').is(':checked')) {
      alert('Please confirm that you understand this action is permanent.');
      return;
    }
    
    // Show loading state
    const $btn = $(this);
    const originalText = $btn.html();
    $btn.html('<i class="fas fa-spinner fa-spin"></i> Deleting...').prop('disabled', true);
    
    // Submit the form via AJAX
    $.ajaxSetup({
      beforeSend: function(xhr, settings) {
        if (!this.crossDomain) {
          xhr.setRequestHeader("X-CSRFToken", $('[name=csrfmiddlewaretoken]').val());
        }
      }
    });
    
    $.ajax({
      url: `/attachment/delete/${currentAttachmentId}/`,
      type: 'POST',
      data: {
        'password': password,
        'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
      },
      success: function(response) {
        $('#deleteAttachmentModal').modal('hide');
        
        // Show success message with redirect info
        if (typeof toastr !== 'undefined') {
          toastr.success(`Attachment deleted successfully! Redirecting to ${currentPatientName}'s profile...`);
        } else {
          alert(`Attachment deleted successfully! Redirecting to ${currentPatientName}'s profile...`);
        }
        
        // Small delay to show the message before redirecting
        setTimeout(() => {
          if (response.redirect_url) {
            window.location.href = response.redirect_url;
          } else {
            location.reload();
          }
        }, 1500);
      },
      error: function(xhr) {
        $btn.html(originalText).prop('disabled', false);
        
        let errorMessage = 'An error occurred while deleting the attachment.';
        if (xhr.responseJSON && xhr.responseJSON.error) {
          errorMessage = xhr.responseJSON.error;
        } else if (xhr.status === 403) {
          errorMessage = 'Invalid password. Please try again.';
        }
        
        if (typeof toastr !== 'undefined') {
          toastr.error(errorMessage);
        } else {
          alert(errorMessage);
        }
        
        // Re-enable form validation
        toggleDeleteButton();
      }
    });
  });
  
  // Clear form when modal is hidden
  $('#deleteAttachmentModal').on('hidden.bs.modal', function() {
    currentAttachmentId = null;
    currentPatientName = null;
    $('#delete-attachment-form')[0].reset();
    $('#modal-delete-btn').prop('disabled', true);
  });
}

// Try to initialize immediately, and also on DOM ready as fallback
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeDeleteModal);
} else {
  initializeDeleteModal();
}

// Also try with jQuery ready as additional fallback
if (typeof $ !== 'undefined') {
  $(document).ready(initializeDeleteModal);
}
</script>
